/**
 * Workflow
 *
 * @copyright: Copyright (C) 2018-2024 Jlowcode Org - All rights reserved.
 * @license  : GNU/GPL http://www.gnu.org/copyleft/gpl.html
 */
define(["jquery","fab/fabrik","lib/debounce/jquery.ba-throttle-debounce"],(function(e,t,a){"use strict";return new Class({Implements:[Events],elementsName:{req_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_ID_LABEL"),req_owner_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_NAME_LABEL"),req_owner_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_NAME_LABEL"),req_request_type_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_REQUEST_TYPE_NAME_LABEL"),req_request_type_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_REQUEST_TYPE_NAME_LABEL"),req_user_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_USER_NAME_LABEL"),req_user_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_USER_NAME_LABEL"),req_created_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_CREATED_DATE_LABEL"),req_status:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_STATUS_LABEL"),req_record_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_RECORD_ID_LABEL"),req_list_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_LIST_ID_LABEL"),req_reviewer_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_REVIEWER_ID_LABEL"),req_revision_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVISION_DATE_LABEL"),req_comment:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_COMMENT_LABEL"),req_file:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_FILE_LABEL"),req_approval:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_APPROVAL_LABEL"),req_user_email:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_LABEL"),req_vote_approve:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_VOTE_APPROVE_LABEL"),req_vote_disapprove:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_VOTE_DISAPPROVE_LABEL")},tableHeadings:{req_request_type_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_REQUEST_TYPE_NAME_LABEL"),req_user_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_USER_NAME_LABEL"),req_created_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_CREATED_DATE_LABEL"),req_owner_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_NAME_LABEL"),req_reviewer_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_REVIEWER_ID_LABEL"),req_revision_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVISION_DATE_LABEL"),req_status:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_STATUS_LABEL"),req_record_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_RECORD_ID_LABEL"),req_approval:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_APPROVAL_LABEL")},initialize:function(r){var o=this;t.getBlock("form_8");this.options=r,this.options.actualPage=1,e(document).ready((function(){var r=new URL(window.location.href),i=new URLSearchParams(r.search),n=i.get("wfl_status")?i.get("wfl_status"):"verify",s=i.get("wfl_order")?i.get("wfl_order"):"req_created_date";s.endsWith("-")&&(s="req_created_date",r.searchParams.set("wfl_order","req_created_date"),window.history.replaceState(null,"",r)),e("#requestTypeSelect").val(n),e("#orderBySelect").val(s),o.watchOrder();var d=e("#modal")[0];if(o.modal=d,o.loadRequestList(d,n,1,null,s),e("#searchTable").on("keyup",(function(e){""===e.target.value?o.loadRequestList(d,"verify",1):e.target.value.length>2&&o.loadRequestList(d,"verify",1,e.target.value)})),e(".modalCloseBtn")[0].onclick=function(){d.style.display="none"},window.onclick=function(e){e.target==d&&(d.style.display="none")},"show_request_id"in o.options){const e=parseInt(o.options.show_request_id,10);o.getRequest(e).done((function(t){var a=JSON.decode(t);o.setForm(o.buildForm(a[0]),d,[a[0]],e),d.show()}))}var l=document.getElementsByClassName("fabrik_row");Array.from(l).each((function(t){var a=o.options.user.hasPermission?Joomla.JText._("PLG_FORM_WORKFLOW_DELETE_RECORD_LIST"):Joomla.JText._("PLG_FORM_WORKFLOW_REPORT_RECORD_LIST"),r=t.getElementsByClassName("dropdown-menu");r[0].style.minWidth="12em";let i=document.createElement("li");i.setAttribute("class","nav-link");let n=document.createElement("a");n.classList.add("btn-default-delete"),n.setAttribute("data-loadmethod","xhr"),n.setAttribute("data-list",t.offsetParent.id),n.setAttribute("list-row-ids",t.id.split("_")[4]+":"+t.id.split("_")[6]),n.setAttribute("data-rowid","xhr"),n.setAttribute("target","_self"),n.setAttribute("title",a),n.innerHTML="<span>"+(o.options.user.hasPermission?o.options.images.trash:o.options.images.danger)+"</span> "+a,i.appendChild(n),r[0].appendChild(i),e(".dropdown-menu a.delete").parent().remove();var s=e(".fabrik_element");Object.keys(s).forEach((function(e){""==s[e].outerText&&(s[e].parentElement.setAttribute("data-bs-toggle","tooltip"),s[e].parentElement.setAttribute("data-bs-placement","top"),s[e].parentElement.setAttribute("title","Completar ou corrigir esses dados"))}))})),e("a.btn-default-delete").on("click",a(2500,!0,(function(a){t.loader.start(e(".listContent"),Joomla.JText._("COM_FABRIK_LOADING"));var r=this.attributes["list-row-ids"].value,i={options:o.options,listRowIds:r,option:"com_fabrik",task:"plugin.pluginAjax",plugin:"workflow",method:"onReportAbuse",g:"form",format:"raw"};e.ajax({url:"",method:"post",data:i,success:function(a){alert(Joomla.JText._("PLG_FORM_WORKFLOW_SUCCESS")),t.loader.stop(e(".listContent"),Joomla.JText._("COM_FABRIK_LOADING")),location.reload()}}).fail((function(e,t,a){var r={data:i,error:a,status:t,jq:e};o.saveLogs(r)}))})))}));var i=e("#requestTypeSelect");for(var n in o.options.statusName)"verify"==n?i.append('<option selected="selected" value="'+n+'">'+o.options.statusName[n]+"</option>"):i.append('<option value="'+n+'">'+o.options.statusName[n]+"</option>");i.change((function(){var t=e(this).children("option:selected").val();e("#orderBySelect").val("req_created_date").change(),o.loadRequestList(o.modal,t,1)}));var s=e("#orderBySelect");for(var n in o.tableHeadings)"req_created_date"==n?(s.append('<option value="'+n+'">'+o.tableHeadings[n]+" - ASC</option>"),s.append('<option selected="selected" value="'+n+'_desc">'+o.tableHeadings[n]+" - DESC</option>")):(s.append('<option value="'+n+'">'+o.tableHeadings[n]+" - ASC</option>"),s.append('<option value="'+n+'_desc">'+o.tableHeadings[n]+" - DESC</option>"));s.change((function(){var t=e(this).children("option:selected").val(),a=e(i).children("option:selected").val();o.loadRequestList(o.modal,a,o.options.actualPage,null,t)}))},setPagination:function(t=1){var a=this;a.options.actualPage=t;var r=e("#workflow-pagination");r.empty();var o=e('<ul class="pagination"></ul>'),i=this.options.requestsCount/5;const n="cursor: pointer;";i=Math.ceil(i);const s=e('<a class="" id="start-button" rel="noreferrer" target="_blank" type="button"><<</a>'),d=e('<a class="" id="pagination-prev" rel="noreferrer" target="_blank" type="button"><</a>'),l=e('<a class="" id="pagination-next" rel="noreferrer" target="_blank" type="button">></a>'),p=e('<a class="" id="pagination-end" rel="noreferrer" target="_blank" type="button">>></a>');1==t?(o.append(e('<li class="page-item"></li>').append(s)),o.append(e('<li class="page-item"></li>').append(d))):(s.on("click",(function(){var t=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,t,1)})),d.on("click",(function(){if(1!=t){var r=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,r,t-1)}})),s.attr("style",n),d.attr("style",n),o.append(e('<li class="page-item"></li>').append(s)),o.append(e('<li class="page-item"></li>').append(d)));for(var _=1;_<=i;_++){const r=e('<a class="" rel="noreferrer" target="_blank" type="button">'+_+"</a>");t==_?o.append(e('<li class="page-item active"></li>').append(r)):(!function(t){r.attr("style",n),r.on("click",(function(){var r=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,r,t)}))}(_),o.append(e('<li class="page-item"></li>').append(r)))}t==i||isNaN(i)?(o.append(e('<li class="page-item"></li>').append(l)),o.append(e('<li class="page-item"></li>').append(p))):(l.on("click",(function(){if(t!=i){var r=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,r,t+1)}})),p.on("click",(function(){var t=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,t,i)})),l.attr("style",n),p.attr("style",n),o.append(e('<li class="page-item"></li>').append(l)),o.append(e('<li class="page-item"></li>').append(p))),4!=e(o).find("li").length?(r.append(o),e("#eventsContainer").css("margin-bottom","0px")):(r.append(""),e("#eventsContainer").css("margin-bottom","30px"))},loadRequestList:function(t,a,r=1,o=null,i="req_created_date"){var n,s=this;i=e("#orderBySelect").val(),"list_requests"==this.options.wfl_action&&this.getRequestsList(a,5,n,o,1).done((function(e){s.options.requestsCount=e,s.setPagination(r)}));var d=e("#tblEntAttributes tbody");d.empty(),d.empty();var l=e("<tr><td  colspan='10'>"+Joomla.JText._("PLG_FORM_WORKFLOW_NO_RECORDS_FOUND")+"</td></tr>");d.append(l),n=1==r?0:5*(r-1),s.getRequestsList(a,5,n,o,0,i).done((function(n){var l=JSON.decode(n);0!==l.length&&d.empty(),s.options.requestsCount=l.requestCount,e.each(l[a],(function(a,r){var o=r.data,i=e("<tr></tr>"),n=e("<td><a style='width: 100%;' id='request_"+o.req_id+"'class='btn'>"+s.options.images.view+"</a></td>");e.each(s.tableHeadings,(function(e,t){if(o[e])if("req_status"==e){var a=s.options.statusName[o[e]];i.append("<td>"+a+"</td>")}else if("req_request_type_name"==e){a=s.options.requestTypeText[o[e]];i.append("<td>"+a+"</td>")}else i.append("<td>"+o[e]+"</td>");else i.append("<td></td>")})),n.on("click",(function(){s.buildForm(o,t,o)})),i.append(n),d.append(i)}));var p=new URL(window.location.href),_=new URLSearchParams(p.search).get("requestId");if(_){var c=e("#request_"+_);if(c.length)return void c.trigger("click");s.loadRequestList(t,a,++r,o,i)}}))},getRequestsList:function(t,a=5,r=0,o="",i="0",n="req_created_date"){var s=this,d="asc";-1!==(n=e("#orderBySelect").val()).indexOf("_desc")&&(n=n.replace("_desc",""),d="desc");var l={req_status:t,wfl_action:this.options.wfl_action,approve_for_own_records:this.options.user.approve_for_own_records,list_id:this.options.listId,user_id:this.options.user.id,allow_review_request:this.options.allow_review_request,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetRequestList",g:"form",length:a,start:r,search:o,count:i,order_by:n,sequence:d};return e.ajax({url:"",method:"get",data:l}).fail((function(e,t,a){var r={data:l,error:a,status:t,jq:e};s.saveLogs(r)}))},canApproveRequests:function(e){e.req_reviewers_votes=null==e.req_reviewers_votes?"":e.req_reviewers_votes;if(-1==e.req_reviewers_votes.indexOf(this.options.user.id)){var t=this.options.user.canApproveRequests;e.req_owner_id===this.options.user.id&&1==this.options.user.approve_for_own_records?t=["edit_field_value","delete_record","edit_field"].indexOf(e.req_request_type_name)>-1:e.req_user_id===this.options.user.id&&(t=!1)}else t=!1;return t},setForm:function(r,o,i,n){var s=this,d=s.options.root_url+"index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=form&plugin=workflow&method=buildForm&mod=formRequest";e.ajax({url:d,method:"post",data:{data:i[0]}}).done((function(n){var d=(n=JSON.parse(n)).fields,l=e("<div></div>"),p=e(e(o).find(".modalBody")[0]);if(p.empty(),n.error)console.warn(n.message);else{if("1"===s.options.workflow_approval_by_votes)var _=e("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_VOTE_APPROVAL_LABEL")+"</h2>"),c=d.voteoptions;else _=e("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_LABEL")+"</h2>"),c=d.yesnooptions;if(l.append(_),l.append(d.commentTextArea),l.append(c),p.append(r),"verify"==i[0].req_status&&s.canApproveRequests(i[0])){var u=e('<button class="btn btn-workflow-modal" style="margin-top: 20px;" id="approveButton">'+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_SAVE_LABEL")+"</button>");setTimeout((()=>{r.append(l)}),1e3),e(u).on("click",a(2500,!0,(function(a){var n=e(this);n.prop("disabled",!0),t.loader.start(e(".modalBody"),Joomla.JText._("COM_FABRIK_LOADING"));const d=parseInt(i[0].req_request_type_id);if("1"==s.options.workflow_approval_by_votes){switch(e("#voteoptions").val()){case"":return void alert(Joomla.JText._("PLG_FORM_WORKFLOW_ERROR_APPROVE_EMPTY"));case"0":i[0].req_vote_disapprove+=1;break;case"1":i[0].req_vote_approve+=1}var l="verify";l=s.options.workflow_votes_to_approve==i[0].req_vote_approve?"approved":l,l=s.options.workflow_votes_to_disapprove==i[0].req_vote_disapprove?"not-approved":l,i[0].req_status=l;var p="approved"==l}else{switch(p=e("#yesnooptions").val()){case"":return void alert(Joomla.JText._("PLG_FORM_WORKFLOW_ERROR_APPROVE_EMPTY"));case"0":i[0].req_approval="0";break;case"1":i[0].req_approval="1"}}e(r).find("#commentTextArea")[0]&&(i[0].req_comment=e(r).find("#commentTextArea")[0].value);var _=JSON.decode(i[0].form_data);for(var c in _)_.hasOwnProperty(c)&&-1!==c.indexOf("_raw")&&delete _[c];if("1"==p)switch(d){case 1:case 2:s.createUpdateRecord(i);break;case 3:const e=i[0].req_record_id,t=i[0].req_list_id;s.deleteRecord(e,t);break;case 4:case 5:s.addEditFields(i)}var u={formData:i,options:s.options,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"ProcessRequest",g:"form"};e.ajax({url:"",method:"post",data:u,success:function(a){o.style.display="none",alert(Joomla.JText._("PLG_FORM_WORKFLOW_SUCCESS")),document.location.reload(!0),n.prop("disabled",!1),t.loader.stop(e(".modalBody"))}}).fail((function(e,t,a){var r={data:u,error:a,status:t,jq:e};s.saveLogs(r)}))}))),p.append(u)}}})).fail((function(e,t,a){var r={url:d,data:i[0],error:a,status:t,jq:e};s.saveLogs(r)}))},deleteRecord:function(t,a){var r=this,o={option:"com_fabrik",task:"plugin.pluginAjax",plugin:"workflow",method:"onDeleteRow",g:"form",rowId:"{"+t+":"+t+"}",listId:a};e.ajax({url:"",method:"get",data:o,success:function(e){}}).fail((function(e,t,a){var i={data:o,error:a,status:t,jq:e};r.saveLogs(i)}))},createUpdateRecord:function(t){var a=this;this.getSessionToken().done((function(r){var o=JSON.decode(t[0].form_data);o[r]="1",o.review=!0,o.req_id=t[0].req_id,o.fabrik_ajax="1",e.ajax({type:"POST",url:"",data:o}).done((function(e){})).fail((function(e,t,r){var i={data:o,error:r,status:t,jq:e};a.saveLogs(i)}))}))},addEditFields:function(t){var a=this,r=JSON.parse(t[0].form_data),o=a.options.root_url+"index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=list&plugin=easyadmin&method=SaveModal";e.ajax({url:o,method:"post",data:r}).done((function(e){})).fail((function(e,t,i){var n={url:o,data:r,error:i,status:t,jq:e};a.saveLogs(n)}))},getLastRecordFormData:function(t,a){var r=this,o={req_record_id:t,req_list_id:a,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetLastRecordFormData",g:"form"};return e.ajax({url:"",method:"get",data:o}).fail((function(e,t,a){var i={data:o,error:a,status:t,jq:e};r.saveLogs(i)}))},compareRecords:function(e,t){const a=this.options.listName;var r={};for(var o in t){var i;if(t.hasOwnProperty(o)&&-1!==o.indexOf(a+"_"))if(e.hasOwnProperty(o)){if(!this.isEqual(t[o],e[o]))(i={}).last=e[o],i.new=t[o],r[o]=i}else(i={}).last=e[o],i.new=t[o],r[o]=i}return r},isEqual:function(e,t){return JSON.encode(e)===JSON.encode(t)},renderFiles:function(t,a){var r=e("<div></div>");if(t){var o=e("<p>"+t+"</p>");r.append(o)}for(var i in a)if(a.hasOwnProperty(i)){var n=e('<p><a target="_blank" href="'+this.options.root_url+a[i]+'">'+a[i]+" </a></p>");r.append(n)}return r},renderFilesOriginalRequest:function(t,a,r){var o=this,i=e("<div></div>");i.attr("style","display: flex;");const n=e("<p>"+t+"</p>"),s=e("<p>"+t+" - "+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_DATA")+"</p>");var d=e("<div></div>"),l=e("<div></div>");return d.append(s),d.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),a.forEach((function(t,a){const r=e('<p style="overflow-wrap: break-word;"><a target="_blank" href="'+o.options.root_url+t.value+'">'+t.value+" </a></p>");d.append(r)})),l.append(n),l.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),Object.values(r).forEach((function(t,a){const r=e('<p style="overflow-wrap: break-word;"><a target="_blank" href="'+o.options.root_url+t+'">'+t+" </a></p>");l.append(r)})),i.append(d),i.append(l),i},createInput:function(t,a,r){var o=e("<div></div>"),i=e('<label for="'+r+'"> </label>'),n=e('<input id="'+r+'" type="text" disabled/>');return e(i).html(t),0!=a&&e(n).val(a),o.append(i),o.append(n),o},createInputRichText:function(t,a,r){var o=e("<div></div>"),i=e('<label for="'+r+'"></label><br>'),n=e('<div style="text-indent: 20px; margin-top: 0px;" id="'+r+'" type="text" disabled>'+a+"</div>");return e(i).html(t),o.append(i),o.append(n),o},createInputsBeforeAfter:function(t,a,r,o){var i=this,n=" - "+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_DATA");const s=e("<div></div>");if(s.attr("style","display: flex;"),o)var d=i.createInputRichText(t,r,t),l=i.createInputRichText(t+n,a,t+n);else d=i.createInput(t,r,t),l=i.createInput(t+n,a,t+n);return d[0].style.paddingLeft="5px",l[0].style.paddingLeft="5px",d[0].style.flex="1",l[0].style.flex="1",s.append(l),s.append(d),s},buildForm:function(t,a,r){var o=this,i=e("<form></form>"),n=e("<div></div>"),s="";switch(parseInt(t.req_request_type_id)){case 1:s=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_ADD_TEXT");break;case 2:s=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_EDIT_TEXT");break;case 3:s=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_DELETE_TEXT");break;case 4:s=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_ADD_FIELD_TEXT");break;case 5:s=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_EDIT_FIELD_TEXT")}n.append("<h2>"+s+"<h2><hr />"),n.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_DATA_LABEL")+"<h2>");var d=o.options.root_url+"index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=form&plugin=workflow&method=buildForm&mod=requestData";e.ajax({url:d,method:"post",data:{data:t}}).done((function(s){if((s=JSON.parse(s)).error)console.warn(s.message);else{var d=JSON.parse(t.form_data);switch(r.req_request_type_id){case"1":var l=Joomla.JText._("PLG_FORM_WORKFLOW_RECORD_DATA_LABEL");break;case"2":case"3":l="<a href='"+s.link+"' target='_blank'>"+Joomla.JText._("PLG_FORM_WORKFLOW_RECORD_DATA_LABEL")+r.req_record_id+"</a>";break;case"4":case"5":l=Joomla.JText._("PLG_FORM_WORKFLOW_RECORD_FIELD_LABEL")+d.easyadmin_modal___name}var p=e("<div></div>");switch(p.attr("class","formDataInputsContainer mt-2"),p.attr("style","dispay: flex;"),p.attr("style","flex-direction: column;"),p.append("<h2>"+l+"<h2>"),p.css("background-color","#e3e3e3"),p.css("padding","10px"),n.append(s.fields),i.append(n),i.append(p),parseInt(t.req_request_type_id)){case 3:case"delete_record":o.getElementsType(t.req_list_id).done((function(e){o.buildFormDeleteRecords(t,p,i)}));break;case 4:case"add_field":o.buildFormAddFields(d,p,i,t);break;case 5:case"edit_field":o.buildFormEditFields(d,p,i,t);break;default:o.getElementsType(d.listid).done((function(e){var a=JSON.decode(e);"add_record"==t.req_request_type_id||1==parseInt(t.req_request_type_id)?o.buildFormAddRecords(a,d,p,i):o.getLastRecordFormData(t.req_record_id,t.req_list_id).done((function(e){o.buildFormEditRecords(a,d,p,e)}))}))}o.setForm(i,a,[r],r.req_id),a.show()}})).fail((function(e,a,r){var i={url:d,data:t,error:r,status:a,jq:e};o.saveLogs(i)}))},buildFormAddRecords:function(e,t,a,r){a.append(this.buildAddDeleteRecordView(t,e)),r.append(a)},buildFormEditRecords:function(t,a,r,o){var i=this,n=!1,s=JSON.decode(o);if(e.isEmptyObject(s))n=!1;else{const e=i.compareRecords(s,a);for(var d in e)if(e.hasOwnProperty(d)){r.append(i.buildEditRecordView(s,a,t)),n=!0;break}}n||r.append(i.buildAddDeleteRecordView(a,t)).append("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_LOG")+"</p>")},buildFormDeleteRecords:function(e,t,a){const r=e.req_record_id,o=this.options.root_url+"component/fabrik/details/"+this.options.listId+"/"+r;t.append("<a class='btn btn-outline-primary' style='background-color: rgb(0, 62, 161); color: #fff !important' href='"+o+"' target='_blank'>"+Joomla.JText._("PLG_FORM_WORKFLOW_CLICK_HERE")+"</a>"),a.append(t)},buildFormAddFields:function(t,a,r,o){var i=this;i.getBuildFormEasyadmin(t,o).done((function(t){a.append(t),r.append(a);try{require(["/plugins/fabrik_list/easyadmin/easyadmin.js"],(function(t){var a=new t(i.options.optsEasyadmin);a.setElementType("_wfl"),a.setElementLabelAdvancedLink("_wfl"),a.showHideElements("show_in_list","element","yesno","","_wfl"),e("#easyadmin_modal___type_wfl").trigger("change"),e('label[for="easyadmin_modal___label_advanced_link_wfl"]').trigger("click",{button:"edit-element",sufix:"_wfl"}),e("#easyadmin_modal___options_dropdown_wfl").attr("disabled",!0),e(".modalContainer #jlow_fabrik_easyadmin_modal___list-auto-complete").attr("disabled",!0)}),(function(e){console.warn(Joomla.JText._("PLG_FORM_WORKFLOW_ERROR_LOAD_EASYADMIN_FILE"),e)}))}catch(e){console.warn(Joomla.JText._("PLG_FORM_WORKFLOW_ERROR_LOAD_EASYADMIN_FILE"),e)}}))},buildFormEditFields:function(t,a,r,o){var i=this,n={formData:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"easyadmin",method:"buildFormEditFieldsWfl",g:"list",requestWorkflow:"1",listid:t.easyadmin_modal___listid,req_status:o.req_status};e.ajax({url:"",method:"post",data:n}).done((function(t){if(0!=(t=JSON.parse(t)).length){var o=e('<div style="display:flex"></div>'),i=e('<div style="width: 50%"></div>'),n=e('<div style="width: 50%"></div>');t.forEach((e=>{i.append(e.old),n.append(e.new)})),o.append(i),o.append(n),a.append(o),r.append(a),e("#easyadmin_modal___options_dropdown_wfl").attr("disabled",!0),e("#easyadmin_modal___options_dropdown_wfl_orig").attr("disabled",!0),e(".modalContainer #jlow_fabrik_easyadmin_modal___list-auto-complete").attr("disabled",!0),e(".modalContainer #jlow_fabrik_easyadmin_modal___list_orig-auto-complete").attr("disabled",!0)}else a.append().append("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_LOG")+"</p>")})).fail((function(e,t,a){var r={data:o,error:a,status:t,jq:e};i.saveLogs(r)}))},getBuildFormEasyadmin:function(t,a){var r=this,o={formData:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"easyadmin",method:"workflowBuildForm",g:"list",requestWorkflow:"1",req_status:a.req_status};return e.ajax({url:"",method:"post",data:o}).fail((function(e,t,a){var i={data:o,error:a,status:t,jq:e};r.saveLogs(i)}))},buildAddDeleteRecordView:function(t,a){var r=this,o=e("<div></div>");const i=this.options.listName;var n={};for(var s in t)if(-1!==s.indexOf(i)){const e=s.replace(i+"___","").replace("_raw","").replace("_value","").replace("-auto-complete","");if(-1!==s.indexOf("_raw"))continue;if(null!=this.options.workflow_ignore_elements&&-1!==this.options.workflow_ignore_elements.indexOf(e))continue;if(t.hasOwnProperty(i+"___"+e+"_value")&&-1===s.indexOf("_value"))continue;var d=t[s];if(-1!==s.indexOf("repeat"))n[s]=d;else{if(null==a[e])continue;switch(a[e].plugin){case"user":if(null==d.last)continue;o.append(r.createInput(e,r.options.user.name,e));break;case"fileupload":try{if("1"==a[e].ajax_upload){var l=t[i+"___"+e].id,p=[],_="";Object.keys(l).forEach((e=>{var t=e.split("/"),a=t.pop();_=t.join("/")+"/",p.push(a)})),o.append(this.buildMultipleElementView(p,e)),o.append(r.renderImgs("new",p,_))}else{var c=i+"_FILE_"+i+"___"+e,u=(p=t[c].name,t[c].type);o.append(this.createInput(e,p,e)),("image"==u[0].split("/")[0]||u.split("/")[0])&&o.append(r.renderImgs("new",p,t[c].path))}}catch{}break;case"date":o.append(this.createInput(e,d.date,e));break;default:Array.isArray(d)?o.append(this.buildMultipleElementView(d,e)):o.append(this.createInput(e,t[s],e))}}}var f=this.processRepeatGroups(n);for(const e in f){const t=f[e];o.append(this.buildRepeatGroupView(t,e))}return o},buildEditRecordView:function(t,a,r){var o=this,i={},n=e("<div></div>");const s=this.options.listName,d=o.compareRecords(t,a);for(var l in d){if(!d.hasOwnProperty(l))continue;if(-1===l.indexOf("_raw")&&d.hasOwnProperty(l+"_raw"))continue;var p=d[l];const t=l.replace(s+"___","").replace("_raw","").replace("_value","").replace("-auto-complete","");if(null!=this.options.workflow_ignore_elements&&-1!==this.options.workflow_ignore_elements.indexOf(t))continue;if(-1!==l.indexOf("_id"))continue;if((-1!==l.indexOf("_raw")||-1!==l.indexOf("-auto-complete"))&&d.hasOwnProperty(s+"___"+t+"_value"))continue;if(-1!==l.indexOf("repeat"))i[l]=p;else{if(null==r[t])continue;switch(r[t].plugin){case"user":if(null!=p.last)continue;var _={last_user_id:p.last[0],new_user_id:p.new[0],option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetUserValueBeforeAfter",g:"form"};e.ajax({url:"",method:"get",data:_,success:function(e){const a=JSON.decode(e);n.append(o.createInputsBeforeAfter(t,a.last,a.new))}}).fail((function(e,t,a){var r={data:_,error:a,status:t,jq:e};o.saveLogs(r)}));break;case"fileupload":var c=r[t].ajax_upload;if(d[s+"_FILE_"+l])var u=s+"_FILE_"+l;else if(d[s+"_FILE_"+s+"___"+t])u=s+"_FILE_"+s+"___"+t;else if("1"==r[t].ajax_upload)u=s+"___"+t;else u="undefined";if(!d.hasOwnProperty(u))continue;if("1"==c){const a=e("<div></div>"),r=e("<div></div>");r.append(""),r.attr("style","display: flex;");var f=e("<div><p>"+t+"</p></div>"),m=e("<div><p>"+t+" - "+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_DATA")+"</p></div>"),v=d[u].last,R=d[u].new.id,L=[],O=[],w=[];(g=[]).name=[],O.name=[],w.last=[],w.new=[],v.forEach((e=>{var t=e.split("/").pop();g.name.push(t)})),Object.keys(R).reverse().forEach((e=>{var t=e.split("/"),a=t.pop();L=t.join("/")+"/",O.name.push(a)})),g.path=L,O.path=L,w.last=g,w.new=O,m.append(this.buildMultipleElementView(g.name)),f.append(this.buildMultipleElementView(O.name)),f[0].style.paddingLeft="5px",m[0].style.paddingLeft="5px",f[0].style.flex="1",m[0].style.flex="1",r.append(m),r.append(f),a.append(r),n.append(a),n.append(o.renderImgs("change",w))}else{var g=null!=d[u].last&&d[u].last.name;n.append(this.createInputsBeforeAfter(t,g,d[u].new.name)),"image"==d[u].new.type.split("/")[0]&&n.append(o.renderImgs("change",d[u]))}break;case"date":n.append(this.createInputsBeforeAfter(t,p.last,p.new.date));break;default:if(Array.isArray(p.new)||Array.isArray("last")){const a=e("<div></div>"),r=e("<div></div>");r.append(""),r.attr("style","display: flex;");f=e("<div><p>"+t+"</p></div>"),m=e("<div><p>"+t+" - "+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_DATA")+"</p></div>");p.last&&null!=p.last&&m.append(o.buildMultipleElementView(p.last)),f.append(o.buildMultipleElementView(p.new)),f[0].style.paddingLeft="5px",m[0].style.paddingLeft="5px",f[0].style.flex="1",m[0].style.flex="1",r.append(m),r.append(f),a.append(r),n.append(a)}else{var h=r[t].rich_text;n.append(this.createInputsBeforeAfter(t,p.last,p.new,h))}}}}for(var l in i){const t=i[l],a=e("<div><p>"+l+"</p></div>"),r=e("<div></div>");r.append(""),r.attr("style","display: flex;");f=e("<div></div>");(m=e("<div></div>")).append(o.buildRepeatGroupView(t.last)),f.append(o.buildRepeatGroupView(t.new)),f[0].style.paddingLeft="5px",m[0].style.paddingLeft="5px",f[0].style.flex="1",m[0].style.flex="1",r.append(m),r.append(f),a.append(r),n.append(a)}return n},buildMultipleElementView:function(t,a=null){var r=e("<div></div>");a&&(r=e("<div><p>"+a+"</p></div>"));var o=e("<ul class='workflow-ul-request'></ul>");return t.forEach((function(e){o.append("<li>"+e+"</li>")})),r.append(o),r},buildRepeatGroupView:function(t,a){var r=e("<div><p>"+(a=a||"")+"</p></div>"),o=e("<ul></ul>"),i=0;return t.forEach((function(t){if(""!==t)if(t!==Object(t))o.append("<li>"+t+"</li>");else{var a=e("<ul></ul>");for(const e in t)t.hasOwnProperty(e)&&a.append("<li>"+t[e]+"</li>");o.append("Checkbox: "),o.append(a)}else i++})),r.append(o),t.length>i?r:null},processRepeatGroups:function(e){var t={};for(const a in e){const r=a.indexOf("___"),o=a.substr(0,r);t.hasOwnProperty(o)||(t[o]=[]),t[o].append(e[a])}return t},processFiles:function(e,t=!1){var a=[];if(t)a=e;else for(const t in e){if(!e.hasOwnProperty(t))continue;const r=e[t];Object.getOwnPropertyNames(r.id).forEach((function(e,t){a.push(e)}))}return a},renderImgs:function(t,a,r=null){var o=this.options.root_url,i=e("<div></div>");i.attr("style","display: flex;");const n=e("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_ACTUAL_IMAGE_DATA")+"</p>"),s=e("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_IMAGE_DATA")+"</p>");var d=e("<div></div>"),l=e("<div></div>");if(l.append(n),l.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),"change"==t){if(d.append(s),d.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),null==a.last)d.append("<p></p>"),d.css("width","100%");else if(Array.isArray(a.last.name))a.last.name.forEach((function(t,r){if(e=>{var t=e.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","bmp","svg","webp","tiff","ico","heic"].includes(t)}){var i=e('<p style="overflow-wrap: break-word;"><img src="'+o+a.last.path+t+'" width="500" height="600"></p>');d.append(i)}}));else{var p=e('<p style="overflow-wrap: break-word;"><img src="'+o+a.last.path+a.last.name+'" width="500" height="600"></p>');d.append(p)}if(i.append(d),Array.isArray(a.new.name))a.new.name.forEach((function(t,r){if(e=>{var t=e.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","bmp","svg","webp","tiff","ico","heic"].includes(t)}){var i=e('<p style="overflow-wrap: break-word;"><img src="'+o+a.new.path+t+'" width="500" height="600"></p>');l.append(i)}}));else{p=e('<p style="overflow-wrap: break-word;"><img src="'+o+a.new.path+a.new.name+'" width="500" height="600"></p>');l.append(p)}i.append(l)}else{if(Array.isArray(a))a.forEach((function(t,a){if(e=>{var t=e.split(".").pop().toLowerCase();return["jpg","jpeg","png","gif","bmp","svg","webp","tiff","ico","heic"].includes(t)}){var i=e('<p style="overflow-wrap: break-word;"><img src="'+o+r+t+'" width="500" height="600"></p>');l.append(i)}}));else{p=e('<p style="overflow-wrap: break-word;"><img src="'+o+r+a+'" width="500" height="600"></p>');l.append(p)}i.append(l)}return i},watchOrder:function(){var a,r,o,i,n=this,s=!1,d=e("#tblEntAttributes").find(".fabrikorder-wfl, .fabrikorder-asc-wfl, .fabrikorder-desc-wfl");d.off("click"),d.on("click",(function(d){var l="",p="",_="",c="",u=e(this),f=u.closest(".fabrik_ordercell");switch("A"!==u.prop("tagName")&&(u=f.find("a")),u.attr("class")){case"fabrikorder-asc-wfl":p="fabrikorder-desc-wfl",_=u.data("data-sort-desc-icon"),c=u.data("data-sort-asc-icon"),"desc",l="_desc","orderdesc.png";break;case"fabrikorder-desc-wfl":p="fabrikorder-wfl",_=u.data("data-sort-icon"),c=u.data("data-sort-desc-icon"),"-",l="_-","ordernone.png";break;case"fabrikorder-wfl":p="fabrikorder-asc-wfl",_=u.data("data-sort-asc-icon"),c=u.data("data-sort-icon"),"asc",l="","orderasc.png"}if(f.attr("class").split(" ").each((function(e){e.contains("_order")&&(s=e.replace("_order","").replace(/^\s+/g,"").replace(/\s+$/g,""))})),s){u.attr("class",p),t.bootstrapped?r=u.find("*[data-isicon]"):(a=u.find("img"),r=u.firstElementChild),n.options.singleOrdering,e("#tblEntAttributes").find(".fabrikorder, .fabrikorder-asc, .fabrikorder-desc").each((function(e){if(t.bootstrapped)switch(o=e.firstElementChild,e.className){case"fabrikorder-asc":o.removeClass(e.data("sort-asc-icon")),o.addClass(e.data("sort-icon"));break;case"fabrikorder-desc":o.removeClass(e.data("sort-desc-icon")),o.addClass(e.data("sort-icon"))}else(a=e.find("img")).length>0&&(i=(i=a.attr("src")).replace("ordernone.png","").replace("orderasc.png","").replace("orderdesc.png",""),i+="ordernone.png",a.attr("src",i))})),t.bootstrapped?(r.removeClass(c),r.addClass(_)):a&&(i=(i=a.attr("src")).replace("ordernone.png","").replace("orderasc.png","").replace("orderdesc.png",""),a.attr("src",i));var m=e("#requestTypeSelect").val(),v=new URL(window.location.href);v.searchParams.set("wfl_order",s+l),v.searchParams.set("wfl_status",m),window.history.replaceState(null,"",v),location.reload(),d.preventDefault()}else console.warn(Joomla.JText._("PLG_FORM_WORKFLOW_ERROR_ORDERING"))}))},getElementsType:function(t){var a=this,r={req_list_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetElementsPlugin",g:"form"};return e.ajax({url:"",method:"get",data:r}).fail((function(e,t,o){var i={data:r,error:o,status:t,jq:e};a.saveLogs(i)}))},getRequest:function(t){var a=this,r={req_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetRequest",g:"form"};return e.ajax({url:"",method:"get",data:r}).fail((function(e,t,o){var i={data:r,error:o,status:t,jq:e};a.saveLogs(i)}))},getElementsPlugin:function(t){var a=this,r={req_list_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetElementsPlugin",g:"form"};return e.ajax({url:"",method:"get",data:r}).fail((function(e,t,o){var i={data:r,error:o,status:t,jq:e};a.saveLogs(i)}))},getSessionToken:function(){var t=this,a={option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetSessionToken",g:"form"};return e.ajax({url:"",method:"get",data:a}).fail((function(e,r,o){var i={data:a,error:o,status:r,jq:e};t.saveLogs(i)}))},saveLogs:function(t){alert(Joomla.JText._("PLG_FABRIK_LIST_EASY_ADMIN_ERROR")),e.ajax({url:"",method:"post",data:{message:JSON.stringify(t),option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",g:"form",plugin:"workflow",method:"saveLogs"}}).done((function(e){location.reload()}))}})}));