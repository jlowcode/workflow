/**
 * Workflow
 *
 * @copyright: Copyright (C) 2018-2024 Jlowcode Org - All rights reserved.
 * @license  : GNU/GPL http://www.gnu.org/copyleft/gpl.html
 */
define(["jquery","fab/fabrik"],(function(e,t){"use strict";return new Class({Implements:[Events],statusName:{verify:Joomla.JText._("PLG_FORM_WORKFLOW_VERIFY"),approved:Joomla.JText._("PLG_FORM_WORKFLOW_APPROVED"),"pre-approved":Joomla.JText._("PLG_FORM_WORKFLOW_PRE_APPROVED"),"not-approved":Joomla.JText._("PLG_FORM_WORKFLOW_NOT_APPROVED")},requestTypeText:{add_record:Joomla.JText._("PLG_FORM_WORKFLOW_ADD_RECORD"),edit_field_value:Joomla.JText._("PLG_FORM_WORKFLOW_EDIT_FIELD_RECORD"),delete_record:Joomla.JText._("PLG_FORM_WORKFLOW_DELETE_RECORD"),add_field:Joomla.JText._("PLG_FORM_WORKFLOW_ADD_FIELD"),edit_field:Joomla.JText._("PLG_FORM_WORKFLOW_EDIT_FIELD")},elementsName:{req_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_ID_LABEL"),req_owner_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_ID_LABEL"),req_owner_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_ID_LABEL"),req_request_type_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_ID_LABEL"),req_request_type_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_ID_LABEL"),req_user_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_USER_ID_LABEL"),req_user_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_USER_ID_LABEL"),req_created_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_CREATED_DATE_LABEL"),req_status:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_STATUS_LABEL"),req_record_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_RECORD_ID_LABEL"),req_list_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_LIST_ID_LABEL"),req_reviewer_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVIEWER_ID_LABEL"),req_revision_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVISION_DATE_LABEL"),req_comment:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_COMMENT_LABEL"),req_file:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_FILE_LABEL"),req_approval:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_LABEL"),req_user_email:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_LABEL"),req_vote_approve:Joomla.JText._("PLG_FORM_WORKFLOW_VOTES_TO_APPROVE_LABEL"),req_vote_disapprove:Joomla.JText._("PLG_FORM_WORKFLOW_VOTES_TO_DISAPPROVE_LABEL")},tableHeadings:{req_request_type_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_ID_LABEL"),req_user_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_USER_ID_LABEL"),req_created_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_CREATED_DATE_LABEL"),req_owner_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_ID_LABEL"),req_reviewer_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVIEWER_ID_LABEL"),req_revision_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVISION_DATE_LABEL"),req_status:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_STATUS_LABEL"),req_record_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_RECORD_ID_LABEL"),req_approval:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_LABEL")},requestsStatus:{verify:"Verify",approved:"Approved","pre-approved":"Pre-Approved","not-approved":"Not Approved"},initialize:function(a){var o=this;t.getBlock("form_8");this.options=a,this.options.actualPage=1,e(document).ready((function(){var t=new URL(window.location.href),a=new URLSearchParams(t.search),r=a.get("status")?a.get("status"):"verify";e("#requestTypeSelect").val(r);var n=e("#modal")[0];if(o.modal=n,o.loadRequestList(n,r),e("#searchTable").on("keyup",(function(e){""===e.target.value?o.loadRequestList(n,"verify",1):e.target.value.length>2&&o.loadRequestList(n,"verify",1,e.target.value)})),e(".modalCloseBtn")[0].onclick=function(){n.style.display="none"},window.onclick=function(e){e.target==n&&(n.style.display="none")},"show_request_id"in o.options){const e=parseInt(o.options.show_request_id,10);o.getRequest(e).done((function(t){var a=JSON.decode(t);o.setForm(o.buildFormTest(a[0]),n,[a[0]],e),n.show()}))}var i=document.getElementsByClassName("fabrik_row");Array.from(i).each((function(t){var a=t.getElementsByClassName("dropdown-menu");a[0].style.minWidth="12em";let r=document.createElement("li");r.setAttribute("class","nav-link");let n=document.createElement("a");n.classList.add("btn-default-delete"),n.setAttribute("data-loadmethod","xhr"),n.setAttribute("data-list",t.offsetParent.id),n.setAttribute("list-row-ids",t.id.split("_")[4]+":"+t.id.split("_")[6]),n.setAttribute("data-rowid","xhr"),n.setAttribute("target","_self"),n.setAttribute("title",Joomla.JText._("PLG_FORM_WORKFLOW_DELETE_RECORD_LIST")),n.innerHTML="<span>"+o.options.images.danger+"</span> "+Joomla.JText._("PLG_FORM_WORKFLOW_DELETE_RECORD_LIST"),r.appendChild(n),a[0].appendChild(r),e(".dropdown-menu a.delete").parent().remove();var i=e(".fabrik_element");Object.keys(i).forEach((function(e){""==i[e].outerText&&(i[e].parentElement.setAttribute("data-bs-toggle","tooltip"),i[e].parentElement.setAttribute("data-bs-placement","top"),i[e].parentElement.setAttribute("title","Completar ou corrigir esses dados"))}))})),e("a.btn-default-delete").on("click",(function(t){const a=e('<div style=" display: flex; position: fixed; background: rgba(0,0,0,0.5);width: 100%;top: 0;height: 100vh;margin: auto;"><img style="margin: auto;" src="https://i.gifer.com/ZKZg.gif"></div>');e("body").append(a);var r=this.attributes["list-row-ids"].value;e.ajax({url:"",method:"get",data:{options:o.options,listRowIds:r,option:"com_fabrik",task:"plugin.pluginAjax",plugin:"workflow",method:"onReportAbuse",g:"form"},success:function(e){alert(Joomla.JText._("PLG_FORM_WORKFLOW_SUCCESS")),location.reload()}})}))}));var r=e("#requestTypeSelect");for(var n in o.requestsStatus)"verify"==n?r.append('<option selected="selected" value="'+n+'">'+o.requestsStatus[n]+"</option>"):r.append('<option value="'+n+'">'+o.requestsStatus[n]+"</option>");r.change((function(){var t=e(this).children("option:selected").val();e("#orderBySelect ").val("req_created_date").change(),o.loadRequestList(o.modal,t,1)}));var i=e("#orderBySelect");for(var n in o.tableHeadings)"req_created_date"==n?(i.append('<option value="'+n+'">'+o.tableHeadings[n]+" - ASC</option>"),i.append('<option selected="selected" value="'+n+'_desc">'+o.tableHeadings[n]+" - DESC</option>")):(i.append('<option value="'+n+'">'+o.tableHeadings[n]+" - ASC</option>"),i.append('<option value="'+n+'_desc">'+o.tableHeadings[n]+" - DESC</option>"));i.change((function(){var t=e(this).children("option:selected").val(),a=e(r).children("option:selected").val();o.loadRequestList(o.modal,a,o.options.actualPage,null,t)}))},onGetSessionToken:function(){return e.ajax({url:"",method:"get",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetSessionToken",g:"form"}})},setPagination:function(t=1){var a=this;a.options.actualPage=t;var o=e("#workflow-pagination");o.empty();var r=e('<ul class="pagination"></ul>'),n=this.options.requestsCount/5;const i="cursor: pointer;";n=Math.ceil(n);const s=e('<a class="" id="start-button" rel="noreferrer" target="_blank" type="button"><<</a>'),l=e('<a class="" id="pagination-prev" rel="noreferrer" target="_blank" type="button"><</a>'),p=e('<a class="" id="pagination-next" rel="noreferrer" target="_blank" type="button">></a>'),_=e('<a class="" id="pagination-end" rel="noreferrer" target="_blank" type="button">>></a>');1==t?(r.append(e('<li class="page-item"></li>').append(s)),r.append(e('<li class="page-item"></li>').append(l))):(s.on("click",(function(){var t=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,t,1)})),l.on("click",(function(){if(1!=t){var o=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,o,t-1)}})),s.attr("style",i),l.attr("style",i),r.append(e('<li class="page-item"></li>').append(s)),r.append(e('<li class="page-item"></li>').append(l)));for(var d=1;d<=n;d++){const o=e('<a class="" rel="noreferrer" target="_blank" type="button">'+d+"</a>");t==d?r.append(e('<li class="page-item active"></li>').append(o)):(!function(t){o.attr("style",i),o.on("click",(function(){var o=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,o,t)}))}(d),r.append(e('<li class="page-item"></li>').append(o)))}t==n||isNaN(n)?(r.append(e('<li class="page-item"></li>').append(p)),r.append(e('<li class="page-item"></li>').append(_))):(p.on("click",(function(){if(t!=n){var o=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,o,t+1)}})),_.on("click",(function(){var t=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,t,n)})),p.attr("style",i),_.attr("style",i),r.append(e('<li class="page-item"></li>').append(p)),r.append(e('<li class="page-item"></li>').append(_))),4!=e(r).find("li").length?(o.append(r),e("#eventsContainer").css("margin-bottom","0px")):(o.append(""),e("#eventsContainer").css("margin-bottom","30px"))},loadRequestList:function(t,a,o=1,r=null,n="req_created_date"){var i,s=this;n=e("#orderBySelect").val(),"list_requests"==this.options.wfl_action&&this.getRequestsList(a,5,i,r,1).done((function(e){s.options.requestsCount=e,s.setPagination(o)}));var l=e("#tblEntAttributes tbody");l.empty(),l.empty();var p=e("<tr><td  colspan='10'>"+Joomla.JText._("PLG_FORM_WORKFLOW_NO_RECORDS_FOUND")+"</td></tr>");l.append(p),i=1==o?0:5*(o-1),s.getRequestsList(a,5,i,r,0,n).done((function(o){var r=JSON.decode(o);0!==r.length&&l.empty(),s.options.requestsCount=r.requestCount,e.each(r[a],(function(a,o){var r=o.data,n=e("<tr></tr>"),i=e("<td><a style='width: 100%;' id='request_"+r.req_id+"'class='btn'>"+s.options.images.view+"</a></td>");e.each(s.tableHeadings,(function(e,t){if(r[e])if("req_status"==e){var a=s.statusName[r[e]];n.append("<td>"+a+"</td>")}else if("req_request_type_name"==e){a=s.requestTypeText[r[e]];n.append("<td>"+a+"</td>")}else n.append("<td>"+r[e]+"</td>");else n.append("<td></td>")})),i.on("click",(function(){s.setForm(s.buildFormTest(r),t,[r],r.req_id),t.show()})),n.append(i),l.append(n)}));var n=new URL(window.location.href),i=new URLSearchParams(n.search).get("requestId");i&&e("#request_"+i).trigger("click")}))},getRequestsList:function(t,a=5,o=0,r="",n="0",i="req_created_date"){var s="asc";return-1!==(i=e("#orderBySelect").val()).indexOf("_desc")&&(i=i.replace("_desc",""),s="desc"),e.ajax({url:"",method:"get",data:{req_status:t,wfl_action:this.options.wfl_action,approve_for_own_records:this.options.user.approve_for_own_records,list_id:this.options.listId,user_id:this.options.user.id,allow_review_request:this.options.allow_review_request,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetRequestList",g:"form",length:a,start:o,search:r,count:n,order_by:i,sequence:s}})},canApproveRequests:function(e){if(e.req_reviewers_votes=null==e.req_reviewers_votes?"":e.req_reviewers_votes,-1==e.req_reviewers_votes.indexOf(this.options.user.id)){var t=this.options.user.canApproveRequests;e.req_owner_id===this.options.user.id&&1==this.options.user.approve_for_own_records?t="edit_field_value"==e.req_request_type_name||"delete_record"==e.req_request_type_name:e.req_user_id===this.options.user.id&&(t=!1)}else t=!1;return t},setForm:function(t,a,o,r){var n=this,i=e(e(a).find(".modalBody")[0]);i.empty();var s=e("<div class='mt-2'></div>"),l=e("<div class='mt-2'></div>"),p=e("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_COMMENT_LABEL")+"</p>"),_=e("<textarea style='width: 100%;height: 5rem;' id='commentTextArea'></textarea>"),d=e("<div class='mt-2 mb-4'></div>"),u=e("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_FILE_LABEL")+"</p>"),c=e("<input type='file' name='uploadFileApprove' id='uploadFileApprove'>"),m=e('<div class="btn-group btn-group-toggle" data-toggle="buttons">\n  <label class="btn btn-success">\n    <input type="radio" name="yesnooptions" id="approveButtonYes" value="yes" autocomplete="off" checked> '+Joomla.JText._("JYES")+'\n  </label>\n  <label class="btn btn-danger">\n    <input type="radio" name="yesnooptions" id="approveButtonNo" value="no" autocomplete="off"> '+Joomla.JText._("JNO")+" \n  </label>\n</div>"),f=e('<div class="btn-group btn-group-toggle" data-toggle="buttons">\n  <label class="btn btn-success">\n    <input type="radio" name="voteoptions" id="voteButtonApprove" value="approve" autocomplete="off" checked> '+Joomla.JText._("PLG_FORM_WORKFLOW_VOTES_IN_FAVOR")+'\n  </label>\n  <label class="btn btn-danger">\n    <input type="radio" name="voteoptions" id="voteButtonDisapprove" value="disapprove" autocomplete="off"> '+Joomla.JText._("PLG_FORM_WORKFLOW_VOTES_AGAINST")+"\n  </label>\n</div>");if("1"===this.options.workflow_approval_by_votes){var O=null==o[0].req_vote_approve?"0":o[0].req_vote_approve,v=null==o[0].req_vote_disapprove?"0":o[0].req_vote_disapprove;(L=e("<p class='mt-2'> <span>"+Joomla.JText._("PLG_FORM_WORKFLOW_PARTIAL_VOTES")+": <br> "+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_LABEL")+O+" ("+Joomla.JText._("PLG_FORM_WORKFLOW_NEEDED_VOTES")+this.options.workflow_votes_to_approve+")<br> "+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_DISAPPROVE_SECTION_LABEL")+v+" ("+Joomla.JText._("PLG_FORM_WORKFLOW_NEEDED_VOTES")+this.options.workflow_votes_to_disapprove+")</span><br>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_VOTE_APPROVAL_LABEL")+" </p>")).append(f);var R=e("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_VOTE_APPROVAL_LABEL")+"</h2>")}else{var L;(L=e("<p class='mt-2'>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_LABEL")+" </p>")).append(m);R=e("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_LABEL")+"</h2>")}if(s.append(p),s.append(_),l.append(u),l.append(c),d.append(R),d.append(s),d.append(l),d.append(L),i.append(t),"verify"==o[0].req_status&&n.canApproveRequests(o[0])){var E=e('<button class="btn btn-primary" id="approveButton">'+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_SAVE_LABEL")+"</button>");setTimeout((()=>{t.append(d)}),2e3),t.append(d),e(E).on("click",(function(){const r=parseInt(o[0].req_request_type_id);var s=e(t).find("#uploadFileApprove");if("1"==n.options.workflow_approval_by_votes){"approve"==e("input[name='voteoptions']:checked").val()?o[0].req_vote_approve+=1:o[0].req_vote_disapprove+=1,i.empty(),i.append(e("<h3>"+Joomla.JText._("PLG_FORM_WORKFLOW_LOADING")+"</h3>"));var l=JSON.decode(o[0].form_data);for(var p in l)l.hasOwnProperty(p)&&-1!==p.indexOf("_raw")&&delete l[p];var _="verify";if(_=n.options.workflow_votes_to_approve==o[0].req_vote_approve?"approved":_,_=n.options.workflow_votes_to_disapprove==o[0].req_vote_disapprove?"not-approved":_,o[0].req_status=_,d="approved"==_)switch(r){case 1:case 2:n.createUpdateRecord(o);break;case 3:const e=o[0].req_record_id,t=o[0].req_list_id;n.deleteRecord(e,t);break;case 4:case 5:n.addEditFields(o)}e.ajax({url:"",method:"post",data:{formData:o,options:n.options,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"ProcessRequest",g:"form"},success:function(e){a.style.display="none",alert(Joomla.JText._("PLG_FORM_WORKFLOW_SUCCESS")),document.location.reload(!0)}})}else{var d="yes"==e("input[name='yesnooptions']:checked").val();i.empty(),i.append(e("<h3>"+Joomla.JText._("PLG_FORM_WORKFLOW_LOADING")+"</h3>")),o[0].req_approval=d?"1":"0",e(t).find("#commentTextArea")[0]&&(o[0].req_comment=e(t).find("#commentTextArea")[0].value);l=JSON.decode(o[0].form_data);for(var p in l)l.hasOwnProperty(p)&&-1!==p.indexOf("_raw")&&delete l[p];if(d)switch(r){case 1:case 2:n.createUpdateRecord(o);break;case 3:const e=o[0].req_record_id,t=o[0].req_list_id;n.deleteRecord(e,t);break;case 4:case 5:n.addEditFields(o)}s.val()?n.uploadFile(s).done((function(t){o[0].req_file=t,e.ajax({url:"",method:"post",data:{formData:o,options:n.options,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"ProcessRequest",g:"form"},success:function(e){a.style.display="none",alert(Joomla.JText._("PLG_FORM_WORKFLOW_SUCCESS")),document.location.reload(!0)}})})):e.ajax({url:"",method:"post",data:{formData:o,options:n.options,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"ProcessRequest",g:"form"},success:function(e){a.style.display="none",alert(Joomla.JText._("PLG_FORM_WORKFLOW_SUCCESS")),document.location.reload(!0)}})}})),i.append(E)}},deleteRecord:function(t,a){e.ajax({url:"",method:"get",data:{option:"com_fabrik",task:"plugin.pluginAjax",plugin:"workflow",method:"onDeleteRow",g:"form",rowId:"{"+t+":"+t+"}",listId:a},success:function(e){}})},createUpdateRecord:function(t){this.getSessionToken().done((function(a){var o=JSON.decode(t[0].form_data);o[a]="1",o.review=!0,o.req_id=t[0].req_id,e.ajax({type:"POST",url:"",data:o}).done((function(e){}))}))},addEditFields:function(t){var a=JSON.parse(t[0].form_data),o=this.options.root_url+"index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=list&plugin=easyadmin&method=SaveModal";e.ajax({url:o,method:"post",data:a}).done((function(e){}))},getLastRecordFormData:function(t){return e.ajax({url:"",method:"get",data:{req_record_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetLastRecordFormData",g:"form"}})},compareRecords:function(e,t){const a=this.options.listName;var o={};for(var r in t){var n;if(t.hasOwnProperty(r)&&-1!==r.indexOf(a+"_"))if(e.hasOwnProperty(r)){if(!this.isEqual(t[r],e[r]))(n={}).last=e[r],n.new=t[r],o[r]=n}else(n={}).last=e[r],n.new=t[r],o[r]=n}return o},isEqual:function(e,t){return JSON.encode(e)===JSON.encode(t)},renderFiles:function(t,a){var o=e("<div></div>");if(t){var r=e("<p>"+t+"</p>");o.append(r)}for(var n in a)if(a.hasOwnProperty(n)){var i=e('<p><a target="_blank" href="'+this.options.root_url+a[n]+'">'+a[n]+" </a></p>");o.append(i)}return o},renderFilesOriginalRequest:function(t,a,o){var r=this,n=e("<div></div>");n.attr("style","display: flex;");const i=e("<p>"+t+"</p>"),s=e("<p>"+t+" - "+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_DATA")+"</p>");var l=e("<div></div>"),p=e("<div></div>");return l.append(s),l.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),a.forEach((function(t,a){const o=e('<p style="overflow-wrap: break-word;"><a target="_blank" href="'+r.options.root_url+t.value+'">'+t.value+" </a></p>");l.append(o)})),p.append(i),p.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),Object.values(o).forEach((function(t,a){const o=e('<p style="overflow-wrap: break-word;"><a target="_blank" href="'+r.options.root_url+t+'">'+t+" </a></p>");p.append(o)})),n.append(l),n.append(p),n},uploadFile:function(t){var a=this.options.root_url+"index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&g=form&plugin=workflow&method=uploadFileToRequest";if(t.val()){var o=e(t[0]).prop("files")[0],r=new FormData;return r.append("file",o),e.ajax({url:a,cache:!1,contentType:!1,processData:!1,data:r,type:"post",success:function(e){}})}},createInput:function(t,a,o){var r=e("<div></div>"),n=e('<label for="'+o+'"> </label>'),i=e('<input id="'+o+'" type="text" disabled/>');return e(n).html(t),e(i).val(a),r.append(n),r.append(i),r},createInputsBeforeAfter:function(t,a=null,o){var r=" - "+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_DATA");const n=e("<div></div>");n.attr("style","display: flex;");const i=this.createInput(t,o,t),s=this.createInput(t+r,a,t+r);return i[0].style.paddingLeft="5px",s[0].style.paddingLeft="5px",i[0].style.flex="1",s[0].style.flex="1",n.append(s),n.append(i),n},buildFormTest:function(t){var a=this,o=e("<form></form>"),r=e("<div></div>"),n="";switch(parseInt(t.req_request_type_id)){case 1:n=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_ADD_TEXT");break;case 2:n=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_EDIT_TEXT");break;case 3:n=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_DELETE_TEXT");break;case 4:n=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_ADD_FIELD_TEXT");break;case 5:n=Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_EDIT_FIELD_TEXT")}for(var i in r.append("<h2>"+n+"<h2><hr />"),r.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_DATA_LABEL")+"<h2>"),t)if("form_data"!=i&&t[i])switch(i){case"req_request_type_id":case"req_id":case"req_revision_date":case"req_list_id":case"req_user_email":case"req_reviewers_votes":case"req_owner_id":case"req_user_id":continue;case"req_file":var s=e("<div></div>"),l=e("<p>"+a.elementsName[i]+"</p>");s.append(l);var p=e('<p><a target="_blank" href="'+this.options.root_url+t[i]+'">'+t[i]+" </a></p>");s.append(p),r.append(s);break;case"req_status":var _=this.statusName[t[i]];const n=a.createInput(a.elementsName[i],_,i);r.append(n);break;case"req_request_type_name":_=this.requestTypeText[t[i]];const c=a.createInput(a.elementsName[i],_,i);r.append(c);break;case"req_record_id":s=e("<div></div>"),l=e('<label for="'+a.elementsName[i]+'">'+a.elementsName[i]+" </label>");s.append(l);var d=o[0].baseURI.split("?")[0];d=-1!=d.indexOf("/list/")?d.replace("list","details")+"/"+t[i]:d+"/details/"+t.req_list_id+"/"+t[i];p=e('<div class="input-group mb-3"><input type="text" class="form-control" placeholder="" disabled="" value="'+t[i]+'"></div>');if(5!=parseInt(t.req_request_type_id)){var u=e('<a target="_blank" href="'+d+'"><button class="btn btn-primary h-100" type="button" id="'+a.elementsName[i]+'">'+Joomla.JText._("PLG_FORM_WORKFLOW_VIEW")+"</button></a>");p.append(u)}s.append(p),r.append(s);break;case"req_vote_approve":case"req_vote_disapprove":_=t[i];const m=a.createInput(Joomla.JText._("PLG_FORM_WORKFLOW_PARTIAL_SCORE")+a.elementsName[i],_,i);r.append(m);break;default:const f=a.createInput(a.elementsName[i],t[i],i);r.append(f)}var c=JSON.parse(t.form_data);a.options.listName;var m=e("<div></div>");switch(m.attr("class","formDataInputsContainer mt-2"),m.attr("style","dispay: flex;"),m.attr("style","flex-direction: column;"),m.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_RECORD_DATA_LABEL")+"<h2>"),m.css("background-color","#e3e3e3"),m.css("padding","10px"),o.append(r),o.append(m),parseInt(t.req_request_type_id)){case 3:case"delete_record":this.getElementsType(t.req_list_id).done((function(e){a.buildFormDeleteRecords(t,m,o)}));break;case 4:case"add_field":a.buildFormAddFields(c,m,o,t);break;case 5:case"edit_field":a.buildFormEditFields(c,m,o,t);break;default:this.getElementsType(c.listid).done((function(e){var r=JSON.decode(e);"add_record"==t.req_request_type_id||1==parseInt(t.req_request_type_id)?a.buildFormAddRecords(r,c,m,o):a.getLastRecordFormData(t.req_record_id).done((function(e){a.buildFormEditRecords(r,c,m,e)}))}))}return o},buildFormAddRecords:function(e,t,a,o){a.append(this.buildAddDeleteRecordView(t,e)),o.append(a)},buildFormEditRecords:function(t,a,o,r){var n=this,i=JSON.decode(r);const s=n.compareRecords(i,a);var l=!1;if(e.isEmptyObject(i))l=!1;else for(var p in s)if(s.hasOwnProperty(p)){o.append(n.buildEditRecordView(i,a,t)),l=!0;break}l||o.append(n.buildAddDeleteRecordView(a,t)).append("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_LOG")+"</p>")},buildFormDeleteRecords:function(e,t,a){const o=e.req_record_id,r=this.options.root_url+"component/fabrik/details/"+this.options.listId+"/"+o;t.append("<a class='btn btn-outline-primary' href='"+r+"' target='_blank'>"+Joomla.JText._("PLG_FORM_WORKFLOW_CLICK_HERE")+"</a>"),a.append(t)},buildFormAddFields:function(t,a,o,r){var n=this;n.getBuildFormEasyadmin(t,r).done((function(t){a.append(t),o.append(a);try{require(["/plugins/fabrik_list/easyadmin/easyadmin.js"],(function(t){var a=new t(n.options.optsEasyadmin);a.setElementType("_wfl"),a.setElementLabelAdvancedLink("_wfl"),a.showHideElements("show_in_list","element","yesno","","_wfl"),e("#easyadmin_modal___type_wfl").trigger("change"),e('label[for="easyadmin_modal___label_advanced_link_wfl"]').trigger("click",{button:"edit-element",sufix:"_wfl"}),e("#easyadmin_modal___options_dropdown_wfl").attr("disabled",!0),e(".modalContainer #jlow_fabrik_easyadmin_modal___list-auto-complete").attr("disabled",!0)}),(function(e){console.warn(Joomla.JText._("PLG_FORM_WORKFLOW_ERROR_LOAD_EASYADMIN_FILE"),e)}))}catch(e){console.warn(Joomla.JText._("PLG_FORM_WORKFLOW_ERROR_LOAD_EASYADMIN_FILE"),e)}}))},buildFormEditFields:function(t,a,o,r){e.ajax({url:"",method:"post",data:{formData:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"easyadmin",method:"buildFormEditFieldsWfl",g:"list",requestWorkflow:"1",listid:t.easyadmin_modal___listid,req_status:r.req_status}}).done((function(t){if(0!=(t=JSON.parse(t)).length){var r=e('<div style="display:flex"></div>'),n=e('<div style="width: 50%"></div>'),i=e('<div style="width: 50%"></div>');t.forEach((e=>{n.append(e.old),i.append(e.new)})),r.append(n),r.append(i),a.append(r),o.append(a),e("#easyadmin_modal___options_dropdown_wfl").attr("disabled",!0),e("#easyadmin_modal___options_dropdown_wfl_orig").attr("disabled",!0),e(".modalContainer #jlow_fabrik_easyadmin_modal___list-auto-complete").attr("disabled",!0),e(".modalContainer #jlow_fabrik_easyadmin_modal___list_orig-auto-complete").attr("disabled",!0)}else a.append().append("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_LOG")+"</p>")}))},getBuildFormEasyadmin:function(t,a){return e.ajax({url:"",method:"post",data:{formData:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"easyadmin",method:"workflowBuildForm",g:"list",requestWorkflow:"1",req_status:a.req_status}})},buildAddDeleteRecordView:function(t,a){var o=this,r=e("<div></div>");const n=this.options.listName;var i={};for(var s in t)if(-1!==s.indexOf(n)){const e=s.replace(n+"___","").replace("_raw","").replace("_value","").replace("-auto-complete","");if(-1!==s.indexOf("_raw"))continue;if(null!=this.options.workflow_ignore_elements&&-1!==this.options.workflow_ignore_elements.indexOf(e))continue;if(t.hasOwnProperty(n+"___"+e+"_value")&&-1===s.indexOf("_value"))continue;var l=t[s];if(-1!==s.indexOf("repeat"))i[s]=l;else if(null!=a[e])if("user"==a[e].plugin&&null!=l.last)r.append(o.createInput(e,o.options.user.name,e));else if("fileupload"==a[e].plugin)try{var p=t[n+"_FILE_"+n+"___"+e].name;Array.isArray(p)?r.append(this.buildMultipleElementView(p,e)):r.append(this.createInput(e,p,e)),("image"==t[n+"_FILE_"+n+"___"+e].type[0].split("/")[0]||t[n+"_FILE_"+n+"___"+e].type.split("/")[0])&&r.append(o.renderImgs("new",p,t[n+"_FILE_"+n+"___"+e].path))}catch{}else"date"==a[e].plugin?r.append(this.createInput(e,l.date,e)):Array.isArray(l)?r.append(this.buildMultipleElementView(l,e)):r.append(this.createInput(e,t[s],e))}var _=this.processRepeatGroups(i);for(const e in _){const t=_[e];r.append(this.buildRepeatGroupView(t,e))}return r},buildEditRecordView:function(t,a,o){var r=this,n={},i=e("<div></div>");const s=this.options.listName,l=r.compareRecords(t,a);for(var p in l){if(!l.hasOwnProperty(p))continue;if(-1===p.indexOf("_raw")&&l.hasOwnProperty(p+"_raw"))continue;var _=l[p];const t=p.replace(s+"___","").replace("_raw","").replace("_value","").replace("-auto-complete","");if(null!=this.options.workflow_ignore_elements&&-1!==this.options.workflow_ignore_elements.indexOf(t))continue;if(-1!==p.indexOf("_id"))continue;if((-1!==p.indexOf("_raw")||-1!==p.indexOf("-auto-complete"))&&l.hasOwnProperty(s+"___"+t+"_value"))continue;if(-1!==p.indexOf("repeat"))n[p]=_;else if(null!=o[t])if("user"==o[t].plugin&&null!=_.last)e.ajax({url:"",method:"get",data:{last_user_id:_.last[0],new_user_id:_.new[0],option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetUserValueBeforeAfter",g:"form"},success:function(e){const a=JSON.decode(e);i.append(r.createInputsBeforeAfter(t,a.last,a.new))}});else if("fileupload"==o[t].plugin){if(l[s+"_FILE_"+p])var d=s+"_FILE_"+p;else if(l[s+"_FILE_"+s+"___"+t])d=s+"_FILE_"+s+"___"+t;else d="undefined";l.hasOwnProperty(d)?null!=l[d].last&&(Array.isArray(_.new)||Array.isArray(_.last)?(i.append(this.buildMultipleElementView(l[d].last.name)),i.append(this.buildMultipleElementView(l[d].new.name)),l[d].new.type[0].split("/")[0]&&i.append(r.renderImgs("change",l[d]))):(i.append(this.createInputsBeforeAfter(t,l[d].last.name,l[d].new.name)),"image"==l[d].new.type.split("/")[0]&&i.append(r.renderImgs("change",l[d])))):l.hasOwnProperty(d)&&(i.append(this.createInput(t,l[d].new.name,t)),"image"!=l[s+"_FILE_"+s+"___"+t].new.type[0].split("/")[0]&&"image"!=l[s+"_FILE_"+s+"___"+t].new.type.split("/")[0]||i.append(r.renderImgs("new",l[d].new.name,l[d].new.path)))}else if("date"==o[t].plugin)i.append(this.createInputsBeforeAfter(t,_.last,_.new.date));else if(Array.isArray(_.new)||Array.isArray("last")){const a=e("<div></div>"),o=e("<div></div>");o.append(""),o.attr("style","display: flex;");var u=e("<div><p>"+t+"</p></div>"),c=e("<div><p>"+t+" - "+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_DATA")+"</p></div>");_.last&&null!=_.last&&c.append(r.buildMultipleElementView(_.last)),u.append(r.buildMultipleElementView(_.new)),u[0].style.paddingLeft="5px",c[0].style.paddingLeft="5px",u[0].style.flex="1",c[0].style.flex="1",o.append(c),o.append(u),a.append(o),i.append(a)}else i.append(this.createInputsBeforeAfter(t,_.last,_.new))}for(var p in n){const t=n[p],a=e("<div><p>"+p+"</p></div>"),o=e("<div></div>");o.append(""),o.attr("style","display: flex;");u=e("<div></div>");(c=e("<div></div>")).append(r.buildRepeatGroupView(t.last)),u.append(r.buildRepeatGroupView(t.new)),u[0].style.paddingLeft="5px",c[0].style.paddingLeft="5px",u[0].style.flex="1",c[0].style.flex="1",o.append(c),o.append(u),a.append(o),i.append(a)}return i},buildMultipleElementView:function(t,a=null){var o=e("<div></div>");a&&(o=e("<div><p>"+a+"</p></div>"));var r=e("<ul class='workflow-ul-request'></ul>");return t.forEach((function(e){r.append("<li>"+e+"</li>")})),o.append(r),o},buildRepeatGroupView:function(t,a){var o=e("<div><p>"+(a=a||"")+"</p></div>"),r=e("<ul></ul>"),n=0;return t.forEach((function(t){if(""!==t)if(t!==Object(t))r.append("<li>"+t+"</li>");else{var a=e("<ul></ul>");for(const e in t)t.hasOwnProperty(e)&&a.append("<li>"+t[e]+"</li>");r.append("Checkbox: "),r.append(a)}else n++})),o.append(r),t.length>n?o:null},processRepeatGroups:function(e){var t={};for(const a in e){const o=a.indexOf("___"),r=a.substr(0,o);t.hasOwnProperty(r)||(t[r]=[]),t[r].append(e[a])}return t},processFiles:function(e,t=!1){var a=[];if(t)a=e;else for(const t in e){if(!e.hasOwnProperty(t))continue;const o=e[t];Object.getOwnPropertyNames(o.id).forEach((function(e,t){a.push(e)}))}return a},renderImgs:function(t,a,o=null){var r=this.options.root_url,n=e("<div></div>");n.attr("style","display: flex;");const i=e("<p>nova imagem</p>"),s=e("<p>imagem - "+Joomla.JText._("PLG_FORM_WORKFLOW_ORIGINAL_DATA")+"</p>");var l=e("<div></div>"),p=e("<div></div>");if(p.append(i),p.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),"change"==t){if(l.append(s),l.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),Array.isArray(a.last.name))a.last.name.forEach((function(t,o){var n=e('<p style="overflow-wrap: break-word;"><img src="'+r+a.last.path+t+'" width="500" height="600"></p>');l.append(n)}));else{var _=e('<p style="overflow-wrap: break-word;"><img src="'+r+a.last.path+a.last.name+'" width="500" height="600"></p>');l.append(_)}if(n.append(l),Array.isArray(a.new.name))a.new.name.forEach((function(t,o){var n=e('<p style="overflow-wrap: break-word;"><img src="'+r+a.new.path+t+'" width="500" height="600"></p>');p.append(n)}));else{_=e('<p style="overflow-wrap: break-word;"><img src="'+r+a.new.path+a.new.name+'" width="500" height="600"></p>');p.append(_)}n.append(p)}else{if(Array.isArray(a))a.forEach((function(t,a){var n=e('<p style="overflow-wrap: break-word;"><img src="'+r+o+t+'" width="500" height="600"></p>');p.append(n)}));else{_=e('<p style="overflow-wrap: break-word;"><img src="'+r+o+a+'" width="500" height="600"></p>');p.append(_)}n.append(p)}return n},getElementsType:function(t){return e.ajax({url:"",method:"get",data:{req_list_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetElementsPlugin",g:"form"}})},getRequest:function(t){return e.ajax({url:"",method:"get",data:{req_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetRequest",g:"form"}})},getElementsPlugin:function(t){return e.ajax({url:"",method:"get",data:{req_list_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetElementsPlugin",g:"form"}})},getSessionToken:function(){return e.ajax({url:"",method:"get",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetSessionToken",g:"form"}})}})}));