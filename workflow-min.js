/**
 * Workflow
 *
 * @copyright: Copyright (C) 2018-2024 Jlowcode Org - All rights reserved.
 * @license  : GNU/GPL http://www.gnu.org/copyleft/gpl.html
 */
define(["jquery","fab/fabrik"],(function(e,t){"use strict";return new Class({Implements:[Events],statusName:{verify:Joomla.JText._("PLG_FORM_WORKFLOW_VERIFY"),approved:Joomla.JText._("PLG_FORM_WORKFLOW_APPROVED"),"pre-approved":Joomla.JText._("PLG_FORM_WORKFLOW_PRE_APPROVED"),"not-approved":Joomla.JText._("PLG_FORM_WORKFLOW_NOTE_APPROVED")},requestTypeText:{add_record:Joomla.JText._("PLG_FORM_WORKFLOW_ADD_RECORD"),edit_field_value:Joomla.JText._("PLG_FORM_WORKFLOW_EDIT_FIELD_RECORD"),delete_record:Joomla.JText._("PLG_FORM_WORKFLOW_DELETE_RECORD")},elementsName:{req_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_ID_LABEL"),req_owner_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_ID_LABEL"),req_owner_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_ID_LABEL"),req_request_type_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_ID_LABEL"),req_request_type_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_ID_LABEL"),req_user_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_USER_ID_LABEL"),req_user_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_USER_ID_LABEL"),req_created_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_CREATED_DATE_LABEL"),req_status:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_STATUS_LABEL"),req_record_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_RECORD_ID_LABEL"),req_list_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_LIST_ID_LABEL"),req_reviewer_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVIEWER_ID_LABEL"),req_revision_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVISION_DATE_LABEL"),req_comment:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_COMMENT_LABEL"),req_file:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_FILE_LABEL"),req_approval:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_LABEL"),req_user_email:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_LABEL"),req_vote_approve:Joomla.JText._("PLG_FORM_WORKFLOW_VOTES_TO_APPROVE_LABEL"),req_vote_disapprove:Joomla.JText._("PLG_FORM_WORKFLOW_VOTES_TO_DISAPPROVE_LABEL")},tableHeadins:{req_request_type_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_ID_LABEL"),req_user_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_USER_ID_LABEL"),req_created_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_CREATED_DATE_LABEL"),req_owner_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQ_OWNER_ID_LABEL"),req_reviewer_name:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVIEWER_ID_LABEL"),req_revision_date:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_REVISION_DATE_LABEL"),req_status:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_STATUS_LABEL"),req_record_id:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_RECORD_ID_LABEL"),req_approval:Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_LABEL")},requestsStatus:{verify:"Verify",approved:"Approved","pre-approved":"Pre-Approved","not-approved":"Not Approved"},initialize:function(a){var r=this;t.getBlock("form_8");this.options=a,this.options.actualPage=1,e(document).ready((function(){var t=e("#modal")[0];if(r.modal=t,r.loadRequestList(t,"verify"),e("#searchTable").on("keyup",(function(e){""===e.target.value?r.loadRequestList(t,"verify",1):e.target.value.length>2&&r.loadRequestList(t,"verify",1,e.target.value)})),e(".modalCloseBtn")[0].onclick=function(){t.style.display="none"},window.onclick=function(e){e.target==t&&(t.style.display="none")},"show_request_id"in r.options){const e=parseInt(r.options.show_request_id,10);r.getRequest(e).done((function(a){var o=JSON.decode(a);r.setForm(r.buildFormTest(o[0]),t,[o[0]],e),t.show()}))}var a=document.getElementsByClassName("fabrik_row");Array.from(a).each((function(t){var a=t.getElementsByClassName("dropdown-menu");a[0].style.minWidth="12em";let r=document.createElement("li");r.setAttribute("class","nav-link");let o=document.createElement("a");o.classList.add("btn-default-delete"),o.setAttribute("data-loadmethod","xhr"),o.setAttribute("data-list",t.offsetParent.id),o.setAttribute("list-row-ids",t.id.split("_")[4]+":"+t.id.split("_")[6]),o.setAttribute("data-rowid","xhr"),o.setAttribute("target","_self"),o.setAttribute("title","Reportar/Excluir"),o.innerHTML='<span><i class="fas fa-exclamation-triangle fa-sm" style="color: #8c8c8c;"></i></span> Reportar/Excluir',r.appendChild(o),a[0].appendChild(r),e(".dropdown-menu a.delete").parent().remove();var n=e(".fabrik_element");Object.keys(n).forEach((function(e){""==n[e].outerText&&(n[e].parentElement.setAttribute("data-bs-toggle","tooltip"),n[e].parentElement.setAttribute("data-bs-placement","top"),n[e].parentElement.setAttribute("title","Completar ou corrigir esses dados"))}))})),e("a.btn-default-delete").on("click",(function(t){const a=e('<div style=" display: flex; position: fixed; background: rgba(0,0,0,0.5);width: 100%;top: 0;height: 100vh;margin: auto;"><img style="margin: auto;" src="https://i.gifer.com/ZKZg.gif"></div>');e("body").append(a);var o=this.attributes["list-row-ids"].value;e.ajax({url:"",method:"get",data:{options:r.options,listRowIds:o,option:"com_fabrik",task:"plugin.pluginAjax",plugin:"workflow",method:"onReportAbuse",g:"form"},success:function(e){alert("Sucesso!"),location.reload()}})}))}));var o=e("#requestTypeSelect");for(var n in r.requestsStatus)"verify"==n?o.append('<option selected="selected" value="'+n+'">'+r.requestsStatus[n]+"</option>"):o.append('<option value="'+n+'">'+r.requestsStatus[n]+"</option>");o.change((function(){var t=e(this).children("option:selected").val();e("#orderBySelect ").val("req_created_date").change(),r.loadRequestList(r.modal,t,1)}));var i=e("#orderBySelect");for(var n in r.tableHeadins)"req_created_date"==n?(i.append('<option value="'+n+'">'+r.tableHeadins[n]+" - ASC</option>"),i.append('<option selected="selected" value="'+n+'_desc">'+r.tableHeadins[n]+" - DESC</option>")):(i.append('<option value="'+n+'">'+r.tableHeadins[n]+" - ASC</option>"),i.append('<option value="'+n+'_desc">'+r.tableHeadins[n]+" - DESC</option>"));i.change((function(){var t=e(this).children("option:selected").val(),a=e(o).children("option:selected").val();r.loadRequestList(r.modal,a,r.options.actualPage,null,t)}))},onGetSessionToken:function(){return e.ajax({url:"",method:"get",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetSessionToken",g:"form"}})},setPagination:function(t=1){var a=this;a.options.actualPage=t;var r=e("#workflow-pagination");r.empty();var o=e('<ul class="pagination-list"></ul>'),n=this.options.requestsCount/5;const i="cursor: pointer;";n=Math.ceil(n);const p=e('<a class="page-link" id="start-button" rel="noreferrer" target="_blank" type="button">'+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_START_LABEL")+"</a>"),s=e('<a class="page-link" id="pagination-prev" rel="noreferrer" target="_blank" type="button">'+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_PREV_LABEL")+"</a>"),l=e('<a class="page-link" id="pagination-next" rel="noreferrer" target="_blank" type="button">'+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_NEXT_LABEL")+"</a>"),_=e('<a class="page-link" id="pagination-end" rel="noreferrer" target="_blank" type="button">'+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_END_LABEL")+"</a>");1==t?(o.append(e('<li class="page-item"></li>').append(p)),o.append(e('<li class="page-item"></li>').append(s))):(p.on("click",(function(){var t=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,t,1)})),s.on("click",(function(){if(1!=t){var r=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,r,t-1)}})),p.attr("style",i),s.attr("style",i),o.append(e("<li></li>").append(p)),o.append(e("<li></li>").append(s)));for(var d=1;d<=n;d++){const r=e('<a class="page-link" rel="noreferrer" target="_blank" type="button">'+d+"</a>");if(t==d)o.append(e('<li class="active"></li>').append(r));else{!function(t){r.attr("style",i),r.on("click",(function(){var r=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,r,t)}))}(d),o.append(e("<li></li>").append(r))}}t==n||isNaN(n)?(o.append(e('<li class="page-item"></li>').append(l)),o.append(e('<li class="page-item"></li>').append(_))):(l.on("click",(function(){if(t!=n){var r=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,r,t+1)}})),_.on("click",(function(){var t=e("#requestTypeSelect")[0].value;a.loadRequestList(a.modal,t,n)})),l.attr("style",i),_.attr("style",i),o.append(e("<li></li>").append(l)),o.append(e("<li></li>").append(_))),r.append(o)},loadRequestList:function(t,a,r=1,o=null,n="req_created_date"){n=e("#orderBySelect").val();var i=this;"list_requests"==this.options.wfl_action&&this.getRequestsList(a,5,p,o,1).done((function(e){i.options.requestsCount=e,i.setPagination(r)}));i=this,e("#tblEntAttributes");var p,s=e("#tblEntAttributes tbody");e('<img style="display:block; margin: auto;" src="https://mir-s3-cdn-cf.behance.net/project_modules/disp/35771931234507.564a1d2403b3a.gif">');s.empty(),s.empty();var l=e("<tr><td  colspan='10'>Nenhum registro encontrado</td></tr>");s.append(l),p=1==r?0:5*(r-1),i.getRequestsList(a,5,p,o,0,n).done((function(r){var o=JSON.decode(r);0!==o.length&&s.empty(),i.options.requestsCount=o.requestCount,e.each(o[a],(function(a,r){var o=r.data,n=e("<tr></tr>"),p=e("<td><a style='width: 100%;' class='btn'><i data-isicon=\"true\" class=\"icon-search \"></a></td>");e.each(i.tableHeadins,(function(e,t){if(o[e])if("req_status"==e){var a=i.statusName[o[e]];n.append("<td>"+a+"</td>")}else if("req_request_type_name"==e){a=i.requestTypeText[o[e]];n.append("<td>"+a+"</td>")}else n.append("<td>"+o[e]+"</td>");else n.append("<td></td>")})),p.on("click",(function(){i.setForm(i.buildFormTest(o),t,[o],o.req_id),t.show()})),n.append(p),s.append(n)}))}))},getRequestsList:function(t,a=5,r=0,o="",n="0",i="req_created_date"){var p="asc";return-1!==(i=e("#orderBySelect").val()).indexOf("_desc")&&(i=i.replace("_desc",""),p="desc"),e.ajax({url:"",method:"get",data:{req_status:t,wfl_action:this.options.wfl_action,approve_for_own_records:this.options.user.approve_for_own_records,list_id:this.options.listId,user_id:this.options.user.id,allow_review_request:this.options.allow_review_request,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetRequestList",g:"form",length:a,start:r,search:o,count:n,order_by:i,sequence:p}})},canApproveRequests:function(e){if(e.req_reviewers_votes=null==e.req_reviewers_votes?"":e.req_reviewers_votes,-1==e.req_reviewers_votes.indexOf(this.options.user.id)){var t=this.options.user.canApproveRequests;e.req_owner_id===this.options.user.id&&1==this.options.user.approve_for_own_records?t="edit_field_value"==e.req_request_type_name||"delete_record"==e.req_request_type_name:e.req_user_id===this.options.user.id&&(t=!1)}else t=!1;return t},setForm:function(t,a,r,o){var n=this,i=e(e(a).find(".modalBody")[0]);i.empty();var p=e("<div class='mt-2'></div>"),s=e("<div class='mt-2'></div>"),l=e("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_COMMENT_LABEL")+"</p>"),_=e("<textarea style='width: 100%;height: 5rem;' id='commentTextArea'></textarea>"),d=e("<div class='mt-2 mb-4'></div>"),u=e("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_FILE_LABEL")+"</p>"),c=e("<input type='file' name='uploadFileApprove' id='uploadFileApprove'>"),f=e('<div class="btn-group btn-group-toggle" data-toggle="buttons">\n  <label class="btn btn-success">\n    <input type="radio" name="yesnooptions" id="approveButtonYes" value="yes" autocomplete="off" checked> Sim\n  </label>\n  <label class="btn btn-danger">\n    <input type="radio" name="yesnooptions" id="approveButtonNo" value="no" autocomplete="off"> Não \n  </label>\n</div>'),m=e('<div class="btn-group btn-group-toggle" data-toggle="buttons">\n  <label class="btn btn-success">\n    <input type="radio" name="voteoptions" id="voteButtonApprove" value="approve" autocomplete="off" checked> A favor\n  </label>\n  <label class="btn btn-danger">\n    <input type="radio" name="voteoptions" id="voteButtonDisapprove" value="disapprove" autocomplete="off"> Contra \n  </label>\n</div>');if("1"===this.options.workflow_approval_by_votes){var v=null==r[0].req_vote_approve?"0":r[0].req_vote_approve,E=null==r[0].req_vote_disapprove?"0":r[0].req_vote_disapprove;(g=e("<p class='mt-2'> <span>Votos Parciais: <br> Aprovar: "+v+" (Necessário "+this.options.workflow_votes_to_approve+")<br> Reprovar: "+E+" (Necessário "+this.options.workflow_votes_to_disapprove+")</span><br>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_VOTE_APPROVAL_LABEL")+" </p>")).append(m);var O=e("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_VOTE_APPROVAL_LABEL")+"</h2>")}else{var g;(g=e("<p class='mt-2'>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_LABEL")+" </p>")).append(f);O=e("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_LABEL")+"</h2>")}if(p.append(l),p.append(_),s.append(u),s.append(c),d.append(O),d.append(p),d.append(s),d.append(g),i.append(t),"verify"==r[0].req_status&&n.canApproveRequests(r[0])){var R=e('<button class="btn btn-primary" id="approveButton">'+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_APPROVAL_SECTION_SAVE_LABEL")+"</button>");setTimeout((()=>{t.append(d)}),2e3),t.append(d),e(R).on("click",(function(){const o=r[0].req_request_type_id;var p=e(t).find("#uploadFileApprove");if("1"==n.options.workflow_approval_by_votes){"approve"==e("input[name='voteoptions']:checked").val()?r[0].req_vote_approve+=1:r[0].req_vote_disapprove+=1,i.empty(),i.append(e("<h3>Carregando... </h3>"));var s=JSON.decode(r[0].form_data);for(var l in s)s.hasOwnProperty(l)&&-1!==l.indexOf("_raw")&&delete s[l];var _="verify";if(_=n.options.workflow_votes_to_approve==r[0].req_vote_approve?"approved":_,_=n.options.workflow_votes_to_disapprove==r[0].req_vote_disapprove?"not-approved":_,r[0].req_status=_,d="approved"==_)if(3==o){const e=r[0].req_record_id,t=r[0].req_list_id;n.deleteRecord(e,t)}else n.createUpdateRecord(r);e.ajax({url:"",method:"post",data:{formData:r,options:n.options,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"ProcessRequest",g:"form"},success:function(e){console.log(e),a.style.display="none",alert("Concluído"),document.location.reload(!0)}})}else{var d="yes"==e("input[name='yesnooptions']:checked").val();i.empty(),i.append(e("<h3>Carregando... </h3>")),r[0].req_approval=d?"1":"0",e(t).find("#commentTextArea")[0]&&(r[0].req_comment=e(t).find("#commentTextArea")[0].value);s=JSON.decode(r[0].form_data);for(var l in s)s.hasOwnProperty(l)&&-1!==l.indexOf("_raw")&&delete s[l];if(d)if(3==o){const e=r[0].req_record_id,t=r[0].req_list_id;n.deleteRecord(e,t)}else n.createUpdateRecord(r);p.val()?n.uploadFile(p).done((function(t){r[0].req_file=t,e.ajax({url:"",method:"post",data:{formData:r,options:n.options,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"ProcessRequest",g:"form"},success:function(e){a.style.display="none",alert("Concluído"),document.location.reload(!0)}})})):e.ajax({url:"",method:"post",data:{formData:r,options:n.options,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"ProcessRequest",g:"form"},success:function(e){a.style.display="none",alert("Concluído"),document.location.reload(!0)}})}})),i.append(R)}},deleteRecord:function(t,a){e.ajax({url:"",method:"get",data:{option:"com_fabrik",task:"plugin.pluginAjax",plugin:"workflow",method:"onDeleteRow",g:"form",rowId:"{"+t+":"+t+"}",listId:a},success:function(e){}})},createUpdateRecord:function(t){this.getSessionToken().done((function(a){var r=JSON.decode(t[0].form_data);r[a]="1",r.review=!0,r.req_id=t[0].req_id,e.ajax({type:"POST",url:"",data:r}).done((function(e){}))}))},getLastRecordFormData:function(t){return e.ajax({url:"",method:"get",data:{req_record_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetLastRecordFormData",g:"form"}})},compareRecords:function(e,t){const a=this.options.listName;var r={};for(var o in t){var n;if(t.hasOwnProperty(o)&&-1!==o.indexOf(a+"_"))if(e.hasOwnProperty(o)){if(!this.isEqual(t[o],e[o]))(n={}).last=e[o],n.new=t[o],r[o]=n}else(n={}).last=e[o],n.new=t[o],r[o]=n}return r},isEqual:function(e,t){return JSON.encode(e)===JSON.encode(t)},renderFiles:function(t,a){var r=e("<div></div>");if(t){var o=e("<p>"+t+"</p>");r.append(o)}for(var n in a)if(a.hasOwnProperty(n)){var i=e('<p><a target="_blank" href="'+this.options.root_url+a[n]+'">'+a[n]+" </a></p>");r.append(i)}return r},renderFilesOriginalRequest:function(t,a,r){var o=this,n=e("<div></div>");n.attr("style","display: flex;");const i=e("<p>"+t+"</p>"),p=e("<p>"+t+"_original</p>");var s=e("<div></div>"),l=e("<div></div>");return s.append(p),s.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),a.forEach((function(t,a){const r=e('<p style="overflow-wrap: break-word;"><a target="_blank" href="'+o.options.root_url+t.value+'">'+t.value+" </a></p>");s.append(r)})),l.append(i),l.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),Object.values(r).forEach((function(t,a){const r=e('<p style="overflow-wrap: break-word;"><a target="_blank" href="'+o.options.root_url+t+'">'+t+" </a></p>");l.append(r)})),n.append(s),n.append(l),n},uploadFile:function(t){if(t.val()){var a=e(t[0]).prop("files")[0],r=new FormData;return r.append("file",a),e.ajax({url:"http://localhost/PITT/fabrik/plugins/fabrik_form/workflow/uploadFile.php",dataType:"text",cache:!1,contentType:!1,processData:!1,data:r,type:"post",success:function(e){}})}},createInput:function(t,a,r){var o=e("<div></div>"),n=e('<label for="'+r+'"> </label>');e(n).html(t);var i=e('<input id="'+r+'" type="text" disabled/>');return e(i).val(a),o.append(n),o.append(i),o},createInputsBeforeAfter:function(t,a=null,r){const o=e("<div></div>");o.attr("style","display: flex;");const n=this.createInput(t,r,t),i=this.createInput(t+"_original",a,t+"_original");return n[0].style.paddingLeft="5px",i[0].style.paddingLeft="5px",n[0].style.flex="1",i[0].style.flex="1",o.append(i),o.append(n),o},buildFormTest:function(t){var a=this,r=e("<form></form>"),o=e("<div></div>");for(var n in 1==t.req_request_type_id?o.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_ADD_TEXT")+"<h2><hr />"):2==t.req_request_type_id?o.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_EDIT_TEXT")+"<h2><hr />"):3==t.req_request_type_id&&o.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_DELETE_TEXT")+"<h2><hr />"),o.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_DATA_LABEL")+"<h2>"),t)if("form_data"!=n&&t[n])switch(n){case"req_request_type_id":case"req_id":case"req_revision_date":case"req_list_id":case"req_user_email":case"req_reviewers_votes":case"req_owner_id":case"req_user_id":continue;case"req_file":var i=e("<div></div>"),p=e("<p>"+a.elementsName[n]+"</p>");i.append(p);var s=e('<p><a target="_blank" href="'+this.options.root_url+t[n]+'">'+t[n]+" </a></p>");i.append(s),o.append(i);break;case"req_status":var l=this.statusName[t[n]];const d=a.createInput(a.elementsName[n],l,n);o.append(d);break;case"req_request_type_name":l=this.requestTypeText[t[n]];const u=a.createInput(a.elementsName[n],l,n);o.append(u);break;case"req_record_id":i=e("<div></div>"),p=e('<label for="'+a.elementsName[n]+'">'+a.elementsName[n]+" </label>");i.append(p);var _=r[0].baseURI.split("?")[0];_=-1!=_.indexOf("list")?_.replace("list","details")+"/"+t[n]:_+"/details/"+t.req_list_id+"/"+t[n];s=e('<div class="input-group mb-3"><input type="text" class="form-control" placeholder="" disabled="" value="'+t[n]+'"><a target="_blank" href="'+_+'"><button class="btn btn-primary h-100" type="button" id="'+a.elementsName[n]+'">Vizualizar</button></a></div>');i.append(s),o.append(i);break;case"req_vote_approve":case"req_vote_disapprove":l=t[n];const c=a.createInput("Pontuação Parcial: "+a.elementsName[n],l,n);o.append(c);break;default:const f=a.createInput(a.elementsName[n],t[n],n);o.append(f)}var d=JSON.parse(t.form_data);a.options.listName;var u=e("<div></div>");if(u.attr("class","formDataInputsContainer mt-2"),u.attr("style","dispay: flex;"),u.attr("style","flex-direction: column;"),u.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_RECORD_DATA_LABEL")+"<h2>"),u.css("background-color","#e3e3e3"),u.css("padding","10px"),r.append(o),r.append(u),"delete_record"==t.req_request_type_id||3==t.req_request_type_id){const e=t.req_record_id;this.getElementsType(t.req_list_id).done((function(t){const o=a.options.root_url+"component/fabrik/details/"+a.options.listId+"/"+e;u.append("<a class='btn btn-outline-primary' href='"+o+"'  target='_blank'>Clique aqui</a> para ver o registro a ser deletado."),r.append(u)}))}else this.getElementsType(d.listid).done((function(o){var n=JSON.decode(o);"add_record"==t.req_request_type_id||1==t.req_request_type_id?(u.append(a.buildAddDeleteRecordView(d,n)),r.append(u)):"edit_field_value"!=t.req_request_type_id&&2!=t.req_request_type_id||a.getLastRecordFormData(t.req_record_id).done((function(t){var r=JSON.decode(t);const o=a.compareRecords(r,d);var i=!1;if(e.isEmptyObject(r))i=!1;else for(var p in o)if(o.hasOwnProperty(p)){u.append(a.buildEditRecordView(r,d,n)),i=!0;break}i||u.append(a.buildAddDeleteRecordView(d,n)).append("<p>"+Joomla.JText._("PLG_FORM_WORKFLOW_LOG")+"</p>")}))}));return r},buildAddDeleteRecordView:function(t,a){var r=this,o=e("<div></div>");const n=this.options.listName;var i={};for(var p in t)if(-1!==p.indexOf(n)){const _=p.replace(n+"___","").replace("_raw","").replace("_value","").replace("-auto-complete","");if(-1!==p.indexOf("_raw"))continue;if(null!=this.options.workflow_ignore_elements&&-1!==this.options.workflow_ignore_elements.indexOf(_))continue;if(t.hasOwnProperty(n+"___"+_+"_value")&&-1===p.indexOf("_value"))continue;var s=t[p];if(-1!==p.indexOf("repeat"))i[p]=s;else if(null!=a[_])if("user"==a[_].plugin&&null!=s.last)e.ajax({url:"",method:"get",data:{user_id:s[0],option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetUserValue",g:"form"},success:function(e){o.append(r.createInput(_,e,_))}});else if("fileupload"==a[_].plugin)try{var l=t[n+"_FILE_"+n+"___"+_].name;Array.isArray(l)?o.append(this.buildMultipleElementView(l,_)):o.append(this.createInput(_,l,_)),("image"==t[n+"_FILE_"+n+"___"+_].type[0].split("/")[0]||t[n+"_FILE_"+n+"___"+_].type.split("/")[0])&&o.append(r.renderImgs("new",l,t[n+"_FILE_"+n+"___"+_].path))}catch{}else"date"==a[_].plugin?o.append(this.createInput(_,s.date,_)):Array.isArray(s)?o.append(this.buildMultipleElementView(s,_)):o.append(this.createInput(_,t[p],_))}var _=this.processRepeatGroups(i);for(const e in _){const t=_[e];o.append(this.buildRepeatGroupView(t,e))}return o},buildEditRecordView:function(t,a,r){var o=this,n={},i=e("<div></div>");const p=this.options.listName,s=o.compareRecords(t,a);for(var l in s){if(!s.hasOwnProperty(l))continue;if(-1===l.indexOf("_raw")&&s.hasOwnProperty(l+"_raw"))continue;var _=s[l];const t=l.replace(p+"___","").replace("_raw","").replace("_value","").replace("-auto-complete","");if(null!=this.options.workflow_ignore_elements&&-1!==this.options.workflow_ignore_elements.indexOf(t))continue;if(-1!==l.indexOf("_id"))continue;if((-1!==l.indexOf("_raw")||-1!==l.indexOf("-auto-complete"))&&s.hasOwnProperty(p+"___"+t+"_value"))continue;if(-1!==l.indexOf("repeat"))n[l]=_;else if(null!=r[t])if("user"==r[t].plugin&&null!=_.last)e.ajax({url:"",method:"get",data:{last_user_id:_.last[0],new_user_id:_.new[0],option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetUserValueBeforeAfter",g:"form"},success:function(e){const a=JSON.decode(e);i.append(o.createInputsBeforeAfter(t,a.last,a.new))}});else if("fileupload"==r[t].plugin){if(s[p+"_FILE_"+l])var d=p+"_FILE_"+l;else if(s[p+"_FILE_"+p+"___"+t])d=p+"_FILE_"+p+"___"+t;else d="undefined";s.hasOwnProperty(d)?null!=s[d].last&&(Array.isArray(_.new)||Array.isArray(_.last)?(i.append(this.buildMultipleElementView(s[d].last.name)),i.append(this.buildMultipleElementView(s[d].new.name)),s[d].new.type[0].split("/")[0]&&i.append(o.renderImgs("change",s[d]))):(i.append(this.createInputsBeforeAfter(t,s[d].last.name,s[d].new.name)),"image"==s[d].new.type.split("/")[0]&&i.append(o.renderImgs("change",s[d])))):s.hasOwnProperty(d)&&(i.append(this.createInput(t,s[d].new.name,t)),"image"!=s[p+"_FILE_"+p+"___"+t].new.type[0].split("/")[0]&&"image"!=s[p+"_FILE_"+p+"___"+t].new.type.split("/")[0]||i.append(o.renderImgs("new",s[d].new.name,s[d].new.path)))}else if("date"==r[t].plugin)i.append(this.createInputsBeforeAfter(t,_.last,_.new.date));else if(Array.isArray(_.new)||Array.isArray("last")){const a=e("<div></div>"),r=e("<div></div>");r.append(""),r.attr("style","display: flex;");var u=e("<div><p>"+t+"</p></div>"),c=e("<div><p>"+t+"_original</p></div>");_.last&&null!=_.last&&c.append(o.buildMultipleElementView(_.last)),u.append(o.buildMultipleElementView(_.new)),u[0].style.paddingLeft="5px",c[0].style.paddingLeft="5px",u[0].style.flex="1",c[0].style.flex="1",r.append(c),r.append(u),a.append(r),i.append(a)}else i.append(this.createInputsBeforeAfter(t,_.last,_.new))}for(var l in n){const t=n[l],a=e("<div><p>"+l+"</p></div>"),r=e("<div></div>");r.append(""),r.attr("style","display: flex;");u=e("<div></div>");(c=e("<div></div>")).append(o.buildRepeatGroupView(t.last)),u.append(o.buildRepeatGroupView(t.new)),u[0].style.paddingLeft="5px",c[0].style.paddingLeft="5px",u[0].style.flex="1",c[0].style.flex="1",r.append(c),r.append(u),a.append(r),i.append(a)}return i},buildMultipleElementView:function(t,a=null){var r=e("<div></div>");a&&(r=e("<div><p>"+a+"</p></div>"));var o=e("<ul class='workflow-ul-request'></ul>");return t.forEach((function(e){o.append("<li>"+e+"</li>")})),r.append(o),r},buildRepeatGroupView:function(t,a){var r=e("<div><p>"+(a=a||"")+"</p></div>"),o=e("<ul></ul>"),n=0;return t.forEach((function(t){if(""!==t)if(t!==Object(t))o.append("<li>"+t+"</li>");else{var a=e("<ul></ul>");for(const e in t)t.hasOwnProperty(e)&&a.append("<li>"+t[e]+"</li>");o.append("Checkbox: "),o.append(a)}else n++})),r.append(o),t.length>n?r:null},processRepeatGroups:function(e){var t={};for(const a in e){const r=a.indexOf("___"),o=a.substr(0,r);t.hasOwnProperty(o)||(t[o]=[]),t[o].append(e[a])}return t},processFiles:function(e,t=!1){var a=[];if(t)a=e;else for(const t in e){if(!e.hasOwnProperty(t))continue;const r=e[t];Object.getOwnPropertyNames(r.id).forEach((function(e,t){a.push(e)}))}return a},buildForm:function(t){var a=this,r=e("<form></form>"),o=e("<div></div>");for(var n in 1==t.req_request_type_id?o.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_ADD_TEXT")+"<h2><hr />"):2==t.req_request_type_id?o.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_EDIT_TEXT")+"<h2><hr />"):3==t.req_request_type_id&&o.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_TYPE_LABEL_DELETE_TEXT")+"<h2><hr />"),o.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_REQUEST_DATA_LABEL")+"<h2>"),t)if("form_data"!=n&&t[n])switch(n){case"req_request_type_id":case"req_id":case"req_revision_date":case"req_list_id":case"req_user_email":continue;case"req_request_type_id":t.req_request_type_id=t.req_request_type_name,delete t.req_request_type_name;var i=a.elementsName[n],p=n;const u=a.createInput(i,t.req_request_type_id,p);o.append(u);break;case"req_file":var s=e("<div></div>"),l=e("<p>"+a.elementsName[n]+"</p>");s.append(l);var _=e('<p><a target="_blank" href="'+this.options.root_url+t[n]+'">'+t[n]+" </a></p>");s.append(_),o.append(s);break;case"req_owner_id":t.req_owner_id=t.req_owner_name,delete t.req_owner_name;const c=a.createInput("Dono do registro",t[n],n);o.append(c);break;case"req_user_id":t.req_user_id=t.req_user_name,delete t.req_user_name;const f=a.createInput("Dono da requisição",t[n],n);o.append(f);break;case"req_record_id":s=e("<div></div>"),l=e('<label for="'+a.elementsName[n]+'">'+a.elementsName[n]+" </label>");s.append(l);var d=-1!=(d=r[0].baseURI.split("?")[0]).indexOf("list")?d+"/"+t[n]:d.replace("list","details")+"/"+t[n];_=e('<div class="input-group mb-3"><input type="text" class="form-control" placeholder="" disabled="" value="'+t[n]+'"><a target="_blank" href="'+r[0].baseURI.split("?")[0].replace("list","details")+"/"+t[n]+'"><button class="btn btn-primary h-100" type="button" id="'+a.elementsName[n]+'">Vizualizar</button></a></div>');s.append(_),o.append(s);break;default:const m=a.createInput(a.elementsName[n],t[n],n);o.append(m)}var u=JSON.parse(t.form_data),c=e("<div></div>");if(c.attr("class","formDataInputsContainer"),c.attr("style","dispay: flex;"),c.attr("style","flex-direction: column;"),c.append("<h2>"+Joomla.JText._("PLG_FORM_WORKFLOW_RECORD_DATA_LABEL")+"<h2>"),r.append(o),"add_record"==t.req_request_type_id){for(var n in u)if(u[n].is_files){delete u[n].is_files;var f=a.renderFiles(n,u[n]);c.append(f)}else{const e=a.createInput(n,u[n],n);c.append(e)}r.append(c)}else"edit_field_value"==t.req_request_type_id&&(a.getRecord(t.req_list_id,t.req_record_id).done((function(e){var r=t.req_record_id;for(var o in u)if(u[o].is_files){const e=a.options.listName;a.getFileUploadOriginals(e,o,r).done((function(e){var t=JSON.decode(e),r=u[o];delete r.is_files,c.append(a.renderFilesOriginalRequest(o,t,r))}))}else if(u[o]!=e[0][o]){const n=o;a.getElementsType(t.req_list_id).done((function(t){const o=JSON.decode(t)[n];if("databasejoin"==o.plugin){var i=JSON.decode(u[n]);if("multilist"==o.database_join_display_type||"checkbox"==o.database_join_display_type){const e=a.options.listName;a.getDatabaseJoinMultipleElements(o.join_db_name,e,n,r,o.join_val_column,o.join_key_column,u[n]).done((function(e){const t=JSON.decode(e),r=t.original,o=r.length,i=t.request,p=i.length;var s="",l="";r.forEach((function(e,t){s+=e.value,s+=t!=o-1?", ":"."})),i.forEach((function(e,t){l+=e.value,l+=t!=p-1?", ":"."})),c.append(a.createInputsBeforeAfter(n,s,l))}))}else Array.isArray(i)?alert("Warning: Element "+n+" is single, but the request has multiple values."):a.getDatabaseJoinSingleElements(o.join_db_name,e[0][n],u[n],o.join_val_column,o.join_key_column).done((function(e){const t=JSON.decode(e),r=t.new[0].value;if("original"in t){const e=t.original[0].value;c.append(a.createInputsBeforeAfter(n,e,r))}else c.append(a.createInputsBeforeAfter(n," ",r))}))}else c.append(a.createInputsBeforeAfter(n,u[n],e[0][n]))}))}})),r.append(c));return r},renderImgs:function(t,a,r=null){var o=e("<div></div>");o.attr("style","display: flex;");const n=e("<p>nova imagem</p>"),i=e("<p>imagem_original</p>");var p=e("<div></div>"),s=e("<div></div>");s.append(n),s.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;");var l=this.options.root_url;if("change"==t){if(p.append(i),p.attr("style","max-width: 50%; border-color: #e0e0e5; border-width: 1px; border-radius: 10px; border-style: solid; margin: 4px; padding: 8px;"),Array.isArray(a.last.name))a.last.name.forEach((function(t,r){var o=e('<p style="overflow-wrap: break-word;"><img src="'+l+a.last.path+t+'" width="500" height="600"></p>');p.append(o)}));else{var _=e('<p style="overflow-wrap: break-word;"><img src="'+l+a.last.path+a.last.name+'" width="500" height="600"></p>');p.append(_)}if(o.append(p),Array.isArray(a.new.name))a.new.name.forEach((function(t,r){var o=e('<p style="overflow-wrap: break-word;"><img src="'+l+a.new.path+t+'" width="500" height="600"></p>');s.append(o)}));else{_=e('<p style="overflow-wrap: break-word;"><img src="'+l+a.new.path+a.new.name+'" width="500" height="600"></p>');s.append(_)}o.append(s)}else{if(Array.isArray(a))a.forEach((function(t,a){var o=e('<p style="overflow-wrap: break-word;"><img src="'+l+r+t+'" width="500" height="600"></p>');s.append(o)}));else{_=e('<p style="overflow-wrap: break-word;"><img src="'+l+r+a+'" width="500" height="600"></p>');s.append(_)}o.append(s)}return o},getDatabaseJoinSingleElements:function(t,a,r,o,n){return e.ajax({url:"",method:"get",data:{join_db_name:t,element_id:r,join_val_column:o,join_key_column:n,original_element_id:a,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetDatabaseJoinSingleData",g:"form"}})},getDatabaseJoinMultipleElements:function(t,a,r,o,n,i,p){return e.ajax({url:"",method:"get",data:{request_elements_array:p,join_val_column:n,join_key_column:i,join_db_name:t,parent_table_name:a,element_name:r,parent_id:o,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetDatabaseJoinMultipleData",g:"form"}})},getFileUploadOriginals:function(t,a,r){return e.ajax({url:"",method:"get",data:{parent_table_name:t,element_name:a,parent_id:r,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetFileUpload",g:"form"}})},getElementsType:function(t){return e.ajax({url:"",method:"get",data:{req_list_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetElementsPlugin",g:"form"}})},getRequest:function(t){return e.ajax({url:"",method:"get",data:{req_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetRequest",g:"form"}})},getRecord:function(t,a){return e.ajax({url:this.options.root_url+"plugins/fabrik_form/workflow/getRecord.php",data:{req_list_id:t,req_record_id:a}})},getElementsPlugin:function(t){return e.ajax({url:"",method:"get",data:{req_list_id:t,option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetElementsPlugin",g:"form"}})},getRequestType:function(t){return e.ajax({url:this.options.root_url+"plugins/fabrik_form/workflow/getRequestType.php",data:{req_request_type_id:t}})},getSessionToken:function(){return e.ajax({url:"",method:"get",data:{option:"com_fabrik",format:"raw",task:"plugin.pluginAjax",plugin:"workflow",method:"GetSessionToken",g:"form"}})}})}));